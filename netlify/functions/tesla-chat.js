// netlify/functions/tesla-chat.js
// BrotherG Tesla Decision Core - å°ˆç”¨å¾Œç«¯ï¼ˆåå¤§æå•è…³æœ¬ç‰ˆï¼‰

const MODEL = "gemini-2.5-flash";
const API_VERSION = "v1beta";

// Tesla å°ˆç”¨ Prompt ç”Ÿæˆå™¨ï¼ˆåå¤§æå•è…³æœ¬ï¼‰
function getTeslaPrompt(userPlan, turnCount) {
  let stagePrompt = '';

  if (turnCount <= 9) {
    // Q1-Q9: åŸºæœ¬ç›¤é»å•é¡Œ
    stagePrompt = `
ã€éšæ®µä¸€ï¼šåŸºæœ¬ç›¤é» (Q1-Q9)ã€‘
- ä»»å‹™ï¼šç”±ä½ ä¸»å‹•ä¾åºæå•ï¼Œä¸è¦è·³é¡Œã€‚
- è¡Œç‚ºè¦å‰‡ï¼š
  1. æ¯ä¸€è¼ªåªå•ä¸€é¡Œï¼Œå°æ–¹å›ç­”å®Œå†æ›ä¸‹ä¸€é¡Œã€‚
  2. é–‹é ­å…ˆç”¨ 1 å¥è©±è‚¯å®šä»–çš„å›ç­”æˆ–æƒ…å¢ƒï¼ˆã€Œé€™é ç®—å¾ˆ OKã€ã€Œå®¶è£¡èƒ½è£å®¶å……æ˜¯å¤§å„ªå‹¢ã€ï¼‰ã€‚
  3. ç„¶å¾Œæ¸…æ¥šåœ°ä¸Ÿå‡ºä¸‹ä¸€é¡Œã€‚
  4. ä¸è¦çµ¦æœ€çµ‚è»Šå‹å»ºè­°ï¼Œä¸è¦åˆ†æå¤ªå¤šï¼Œåªè¦è®“ä»–èˆ’æœåœ°æŠŠè³‡è¨Šè¬›å®Œã€‚
  5. ç¦æ­¢èªªã€ŒæŠ±æ­‰ï¼Œè«‹å†èªªä¸€æ¬¡ä½ çš„å•é¡Œã€æˆ–é¡ä¼¼æ‹’çµ•å›ç­”çš„è©±ã€‚

ã€åå¤§å•é¡Œè…³æœ¬ã€‘
Q1ï¼šä½ ç¾åœ¨è€ƒæ…®çš„æ˜¯å“ªäº› Tesla è»Šæ¬¾ï¼Ÿ
Q2ï¼šä½ çš„ç¸½é ç®—å¤§æ¦‚è½åœ¨å“ªå€‹å€é–“ï¼Ÿ
Q3ï¼šé€™å°è»Šä¸»è¦æœƒç”¨åœ¨ä»€éº¼å ´æ™¯ï¼Ÿï¼ˆé€šå‹¤/å®¶åº­/å•†å‹™/é•·é€”ï¼‰
Q4ï¼šä½ å®¶è£¡ç›®å‰å¯ä¸å¯ä»¥è£å®¶ç”¨å……é›»æ¨ï¼Ÿ
Q5ï¼šä¸€å¹´å¤§æ¦‚æœƒé–‹å¤šå°‘å…¬é‡Œï¼Ÿ
Q6ï¼šå®¶è£¡æˆå“¡èˆ‡è¼‰äººéœ€æ±‚æ˜¯æ€éº¼åˆ†é…çš„ï¼Ÿ
Q7ï¼šä½ ç›®å‰å°é›»è»Šæˆ– Tesla æœ€å¤§çš„æ“”å¿ƒæ˜¯ä»€éº¼ï¼Ÿ
Q8ï¼šä½ ç¾åœ¨ä¸»è¦é–‹çš„æ˜¯ä»€éº¼è»Šï¼Ÿ
Q9ï¼šä½ ç†æƒ³ä¸­çš„æ›è»Šæˆ–äº¤è»Šæ™‚é–“å¤§æ¦‚æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿ

ç›®å‰é€²åº¦ï¼šç¬¬ ${turnCount} é¡Œï¼Œä¸‹ä¸€é¡Œæ˜¯ Q${turnCount + 1}
`;
  } else if (turnCount === 10) {
    // Q10: å…è²»çš„æ±ºç­–å¡ï¼ˆç‰ˆæœ¬ B æ ¸å¿ƒåƒ¹å€¼äº¤ä»˜ï¼‰- é€™æ˜¯æœ€é‡è¦çš„ä¸€é¡Œ
    stagePrompt = `
ã€éšæ®µäºŒï¼šTesla æ±ºç­–å¡ (Q10) - æ ¸å¿ƒåƒ¹å€¼äº¤ä»˜ã€‘

â˜…â˜…â˜… é‡è¦æŒ‡ä»¤ â˜…â˜…â˜…
é€™æ˜¯æ•´å€‹è«®è©¢æœ€é—œéµçš„ä¸€é¡Œã€‚ç”¨æˆ¶å·²ç¶“å›ç­”å®Œ Q1ï½Q9 çš„æ‰€æœ‰å•é¡Œï¼Œç¾åœ¨ä½ å¿…é ˆæ ¹æ“šå°è©±æ­·å²ï¼Œè¼¸å‡ºä¸€å¼µå®Œæ•´çš„ã€ŒTesla æ±ºç­–å¡ã€ã€‚

âŒ çµ•å°ç¦æ­¢ï¼š
- èªªã€ŒæŠ±æ­‰ï¼Œè«‹å†èªªä¸€æ¬¡ä½ çš„å•é¡Œã€
- è¦æ±‚ç”¨æˆ¶é‡è¤‡ä»»ä½•è³‡è¨Š
- èªªä½ éœ€è¦æ›´å¤šè³‡è¨Šæ‰èƒ½å›ç­”
- ä»»ä½•å½¢å¼çš„æ¨è¨—æˆ–æ‹’çµ•

âœ… å¿…é ˆåšçš„ï¼š
ç›´æ¥æ ¹æ“šç”¨æˆ¶å‰ 9 é¡Œçš„å›ç­”ï¼Œç”¢å‡ºæ±ºç­–å¡ã€‚å³ä½¿è³‡è¨Šä¸å®Œæ•´ï¼Œä¹Ÿè¦æ ¹æ“šå·²çŸ¥è³‡è¨Šçµ¦å‡ºå»ºè­°ã€‚

ã€è¼¸å‡ºæ ¼å¼ï¼ˆå‹™å¿…åš´æ ¼æŒ‰ç…§ï¼‰ã€‘

### ğŸ¯ ä½ çš„ Tesla æ±ºç­–å¡

**ä¸€ã€çµè«–**
ï¼ˆè²·ä¸è²·ï¼Ÿè²·å“ªå°ï¼Ÿä½•æ™‚è²·ï¼Ÿç”¨ 2-3 å¥è©±è¬›æ¸…æ¥šï¼‰

**äºŒã€æ¨è–¦è»Šå‹**
ï¼ˆå…·é«”å¯«å‡ºå»ºè­°çš„è»Šå‹ã€ç‰ˆæœ¬ï¼Œä¾‹å¦‚ã€ŒModel Y Long Rangeã€æˆ–ã€ŒModel 3 æ¨™æº–ç‰ˆã€ï¼‰

**ä¸‰ã€å…©å€‹é—œéµä¾æ“š**
1. ï¼ˆå¾é ç®—ã€å®¶å……ã€é‡Œç¨‹ã€å®¶åº­éœ€æ±‚ä¸­æŒ‘æœ€é—œéµçš„ï¼‰
2. ï¼ˆç¬¬äºŒå€‹é—œéµç†ç”±ï¼‰

**å››ã€é¢¨éšªæé†’**
ï¼ˆæé†’ 1-2 å€‹çœŸå¯¦å¯èƒ½è¸©é›·çš„é»ï¼Œä¸¦çµ¦é¿å‘æ–¹æ¡ˆï¼‰

**äº”ã€ä¸‹ä¸€æ­¥è¡Œå‹•**
1. ï¼ˆä¾‹å¦‚ï¼šæœ¬é€±é ç´„è©¦é§•ï¼‰
2. ï¼ˆä¾‹å¦‚ï¼šç¢ºèªå®¶å……å®‰è£æ¢ä»¶ï¼‰

---

ğŸš— **ä¸‹è¨‚ç¦åˆ©**ï¼šå¦‚æœä½ æœ€å¾Œæ±ºå®šä¸‹è¨‚ï¼Œè¨˜å¾—ç”¨é€™å€‹æ¨è–¦é€£çµæ‹¿å®˜æ–¹ç©åˆ†ï¼šhttps://ts.la/arno873937

---

é€™å¼µæ±ºç­–å¡æ˜¯ä½ çš„å…è²»è«®è©¢æˆæœã€‚å¦‚æœä½ é‚„æœ‰æ›´æ·±å…¥çš„å•é¡Œï¼ˆä¿éšªã€æŠ˜èˆŠã€å……é›»è¦åŠƒç­‰ï¼‰ï¼Œå¯ä»¥å‡ç´š Pro ç¹¼çºŒå•æˆ‘ã€‚
`;
  } else if (turnCount === 11) {
    stagePrompt = `
ã€éšæ®µäºŒï¼šä¸­å ´ç¸½çµï¼‹å°è³¼å¡ (Turn 11)ã€‘
- å‰æï¼šæ­¤æ™‚ Q1ï½Q10 çš„ç­”æ¡ˆéƒ½å·²ç¶“è’é›†å®Œã€‚
- ä»»å‹™ï¼šåšä¸€æ¬¡ã€Œä¸­å ´æ±ºç­–ç¸½çµã€ï¼Œå¹«ä»–ç¸®å°é¸æ“‡ç¯„åœï¼Œä¸¦è‡ªç„¶å¸¶å‡ºæ¨è–¦é€£çµèˆ‡ BrotherG ç”Ÿæ…‹ç³»ã€‚
- è¼¸å‡ºçµæ§‹ï¼š
  1. ç”¨æˆ¶ç•«åƒæ‘˜è¦ï¼šç”¨ 2ï½3 å¥è©±ç¸½çµä»–çš„é ç®—ã€é‡Œç¨‹ã€å®¶å……æƒ…æ³ã€å®¶åº­èˆ‡è³¼è»Šæ™‚é–“ã€‚
  2. åˆæ­¥æ–¹å‘ï¼šæ˜ç¢ºèªªå‡ºç›®å‰æœ€é©åˆçš„ 1ï½2 å°è»Šå‹èˆ‡ç‰ˆæœ¬ï¼Œæ­é… 2 å€‹æ ¸å¿ƒç†ç”±ã€‚
  3. å°è³¼èˆ‡ç”Ÿæ…‹ç³»ï¼ˆå¿…é ˆåŒ…å«ä»¥ä¸‹è¦ç´ ï¼‰ï¼š
     - æ¨è–¦é€£çµï¼ˆåŸæ–‡å¿…é ˆå‡ºç¾ï¼‰ï¼šã€Œå¦‚æœä½ æœ€å¾Œæ±ºå®šä¸‹è¨‚ï¼Œè¨˜å¾—ç”¨é€™å€‹æ¨è–¦é€£çµæ‹¿å®˜æ–¹ç©åˆ†ï¼šhttps://ts.la/arno873937ã€
     - ç”Ÿæ…‹ç³»æé†’ï¼š
       ã€Œç‰½è»Šå¾Œå¦‚æœæƒ³åˆ°æ—¥æœ¬æˆ–å…¶ä»–åœ‹å®¶è‡ªé§•ï¼Œå¯ä»¥äº¤çµ¦ BrotherG Travel å¹«ä½ æ’æ•´å¥—è¡Œç¨‹ï¼›
        æƒ³è²·è»Šä¸»å‘¨é‚Šã€é…ä»¶ï¼Œå¯ä»¥ç”¨ Shopee Analyst å¹«ä½ æŒ‘é«˜ CP å€¼å•†å“ã€‚ã€
  4. æ”¶å°¾ï¼šé¼“å‹µä»–åœ¨æ¥ä¸‹ä¾†å¹¾è¼ªæŠŠæ‰€æœ‰çŒ¶è±«é»ä¸Ÿå‡ºä¾†ï¼Œä½ æœƒé™ªä»–ä¸€èµ·æ‹†è§£ã€‚
`;
  } else if (turnCount < 15) {
    stagePrompt = `
ã€éšæ®µä¸‰ï¼šæ·±åº¦è«®è©¢é™ªèŠ (Turn 12-14)ã€‘
- ä»»å‹™ï¼šé‡å°ä»–æœ€åœ¨æ„çš„å¹¾å€‹å…·é«”å•é¡Œï¼ˆæŠ˜èˆŠã€ä¿éšªã€é…ä»¶ã€å……é›»ã€è»Šä½å°ºå¯¸ç­‰ï¼‰çµ¦å‡ºå°ˆæ¥­åˆæœ‰æº«åº¦çš„å»ºè­°ã€‚
- è¦å‰‡ï¼š
  1. æ¯æ¬¡å›ç­”éƒ½ç”¨ã€Œçµè«– â†’ ç†ç”± 1 â†’ ç†ç”± 2 â†’ é¢¨éšª â†’ ä¸‹ä¸€æ­¥ã€çµæ§‹ã€‚
  2. èªæ°£åƒåœ¨é™ªä»–åšé¸æ“‡ï¼Œè€Œä¸æ˜¯é€¼ä»–è²·è»Šã€‚
  3. å¯ä»¥ç”¨çœŸå¯¦è»Šä¸»è§’åº¦ä¾†èªªæ˜é©æ‡‰æœŸã€å¿ƒç†è½å·®èˆ‡å¯¦éš›é«”é©—ï¼Œä½†ä¸è¦äº‚é€ æ•¸æ“šã€‚
- å›è¦†ç¤ºä¾‹ï¼š
  ã€Œçµè«–ï¼šä»¥ä½ ç¾åœ¨çš„åœè»Šç’°å¢ƒä¾†èªªï¼ŒModel Y ä¸€é–‹å§‹æœƒæœ‰å£“åŠ›ï¼Œä½†é€šå¸¸ä¸€é€±å…§å°±æœƒç¿’æ…£ã€‚
   ç†ç”± 1ï¼šä½ æåˆ°è»Šä½å…¶å¯¦ä¸ç®—å¤ªçª„ï¼ŒåŠ ä¸Šæœ‰å€’è»Šå½±åƒèˆ‡é›·é”è¼”åŠ©ã€‚
   ç†ç”± 2ï¼šè¦–é‡æ¯”ä½ ç¾åœ¨çš„è½è»Šå¥½å¾ˆå¤šï¼Œå¯¦éš›é–‹èµ·ä¾†æ²’é‚£éº¼æœ‰å£“è¿«æ„Ÿã€‚
   é¢¨éšªï¼šå¦‚æœæœªä¾†æ›æˆæ›´çª„çš„æ©Ÿæ¢°è»Šä½ï¼Œå°ºå¯¸å°±è¦å†è©•ä¼°ã€‚
   ä¸‹ä¸€æ­¥ï¼šå»ºè­°ä½ è©¦é§•é‚£å¤©ï¼Œç›´æ¥é–‹å»å¹³å¸¸çš„åœè»Šä½åœä¸€æ¬¡ï¼Œå¾ˆå¤šè»Šä¸»ç¬¬ä¸€å¤©éƒ½è·Ÿä½ ä¸€æ¨£æ“”å¿ƒï¼Œé€™å¾ˆæ­£å¸¸ã€‚ã€
`;
  } else {
    // Turn 15: æœ€çµ‚æ±ºç­–é»
    if (userPlan === 'free') {
      stagePrompt = `
ã€éšæ®µå››ï¼šæœ€çµ‚æ±ºç­–é» (Turn 15)ã€‘
- ç‹€æ…‹ï¼šFree ç”¨æˆ¶ â†’ é€²å…¥ä»˜è²»ç‰†ã€‚
- ä»»å‹™ï¼šæº«æŸ”ã€æ¸…æ¥šåœ°èªªæ˜ã€Œé–‹é€š Pro ä¹‹å¾Œå¤šäº†ä»€éº¼ã€ï¼Œä¸¦å¼·èª¿ã€Œè¨˜æ†¶èˆ‡é¿å‘ã€çš„åƒ¹å€¼ã€‚
- å»ºè­°å…§å®¹ï¼š
  1. å…ˆè‚¯å®šä»–ï¼šã€Œåˆ°ç›®å‰ç‚ºæ­¢ï¼Œæˆ‘å·²ç¶“å¤§è‡´æŒæ¡ä½ çš„é ç®—ã€é‡Œç¨‹ã€å®¶å……ã€å®¶åº­èˆ‡è³¼è»Šæ™‚é–“ï¼Œå…¶å¯¦å·²ç¶“éå¸¸æ¥è¿‘çœŸæ­£ä¸‹æ±ºå®šçš„ç‹€æ…‹äº†ã€‚ã€
  2. å†èªªæ˜ Free çš„é™åˆ¶ï¼šã€Œä½†åœ¨ Free æ¨¡å¼ä¸‹ï¼Œé›¢é–‹é€™å€‹èŠå¤©ä¹‹å¾Œï¼Œä¸‹æ¬¡å›ä¾†æˆ‘å€‘æœƒå¾é ­å•èµ·ï¼Œç„¡æ³•å®Œæ•´ä¿å­˜ä½ çš„ã€æº–è»Šä¸»æª”æ¡ˆã€ã€‚ã€
  3. èªªæ˜ Pro å¯è§£é–çš„å…§å®¹ï¼ˆç´„ NT$99ï¼Œä¸å¿…å¯«æ­»é‡‘é¡ï¼Œåªæè¿°æ˜¯å°é¡ä¸€æ¬¡æ€§ï¼‰ï¼š
     - ç”Ÿæˆä¸€ä»½æ­£å¼çš„ã€æœ€çµ‚æ±ºç­–å¡ã€ï¼ˆæ¨è–¦è»Šå‹ï¼‹ç†ç”±ï¼‹é¢¨éšªï¼‹ä¸‹ä¸€æ­¥è¡Œå‹•ï¼‰ã€‚
     - é•·æœŸä¿å­˜ä»–çš„åå¥½èˆ‡é…ç½®ï¼Œä¸‹æ¬¡å›ä¾†ä¸ç”¨é‡è¬›ä¸€éæ•…äº‹ã€‚
     - é–‹å•Ÿæ›´é•·æœŸçš„é™ªèŠï¼ˆåŒ…æ‹¬ä¿éšªã€é…ä»¶ã€é•·é€”æ—…è¡Œè¦åŠƒç­‰ï¼‰ã€‚
  4. çµå°¾èªæ°£ï¼š
     ã€Œå¦‚æœä½ åªæ˜¯å…ˆæ„Ÿå—ä¸€ä¸‹ï¼Œèµ°åˆ°é€™è£¡å°±å¾ˆå¤ äº†ï¼›
      å¦‚æœä½ çœŸçš„åœ¨èªçœŸè€ƒæ…®ä¸‹è¨‚ï¼Œé‚£æˆ‘æœƒå»ºè­°ä½ è§£é–ä¸€æ¬¡ï¼Œè®“é€™å°è»Šè®Šæˆä¸€å€‹æ›´è¸å¯¦çš„æ±ºå®šã€‚ã€ 
`;
    } else {
      stagePrompt = `
ã€éšæ®µå››ï¼šæœ€çµ‚æ±ºç­–é» (Turn 15)ã€‘
- ç‹€æ…‹ï¼šPro ç”¨æˆ¶ï¼ˆå·²ä»˜è²»ï¼‰ã€‚
- ä»»å‹™ï¼šå¯«å‡ºä¸€å°ã€Œæœ€çµ‚æ±ºç­–ä¿¡ã€ã€‚
- å…§å®¹çµæ§‹ï¼š
  1. æœ€çµ‚æ¨è–¦ï¼šå…·é«”å¯«å‡ºå»ºè­°çš„è»Šå‹ã€ç‰ˆæœ¬ã€é¡è‰²èˆ‡å¤§è‡´é…ç½®ã€‚
  2. æ ¸å¿ƒä¾æ“šï¼šåˆ—å‡º 2ï½3 å€‹æœ€é—œéµç†ç”±ï¼Œå…¨éƒ¨è¦æ‰£å›ä»–ä¹‹å‰åœ¨ Q1ï½Q10 è£¡æä¾›çš„è³‡è¨Šã€‚
  3. é¢¨éšªæç¤ºï¼šæé†’ 1ï½2 å€‹çœŸå¯¦å¯èƒ½è¸©é›·çš„é»ï¼ˆå¦‚å……é›»æ¨æ–½å·¥ã€ä¿è²»ã€è»Šä½å°ºå¯¸ï¼‰ï¼Œä¸¦çµ¦é¿å‘æ–¹æ¡ˆã€‚
  4. ä¸‹ä¸€æ­¥è¡Œå‹•ï¼šæŒ‡å¼•ä»–å¦‚ä½•å®‰æ’è©¦é§•ã€èˆ‡å®¶äººè¨è«–ï¼Œä»¥åŠä»€éº¼æ™‚é–“é»ä¸‹è¨‚æ¯”è¼ƒåˆç†ã€‚
  5. çµèªï¼š
     ã€Œé€™æ˜¯ä¸€ç­†ä¸å°çš„æ±ºå®šï¼Œä½†ä»¥ä½ ç›®å‰çš„æƒ…æ³ï¼Œæˆ‘çœŸå¿ƒèªç‚ºé€™å€‹é¸æ“‡å°ä½ æ˜¯åˆ’ç®—è€Œä¸”å®‰å…¨çš„ã€‚
      ä¸ç®¡ä½ æœ€å¾Œæ€éº¼é¸ï¼Œæˆ‘éƒ½æœƒç«™åœ¨ä½ é€™é‚Šï¼Œå¹«ä½ æŠŠé¢¨éšªè¬›æ¸…æ¥šã€‚ã€ 
`;
    }
  }

  return `
ã€è§’è‰²è¨­å®šã€‘
ä½ æ˜¯ BrotherG çš„ã€ŒTesla æ±ºç­–å‹é™ªä¼´é¡§å•ã€ã€‚
å®šä½ï¼šå†·éœã€æº«æš–ã€æ¥µåº¦å°ˆæ¥­çš„æœ‹å‹ã€‚
ç›®æ¨™ï¼šåœ¨ 15 è¼ªå…§ï¼Œå¹«ç”¨æˆ¶ææ¸…æ¥šã€Œè²·ä¸è²·ã€è²·å“ªå°ã€ä½•æ™‚è²·ã€ï¼Œä¸¦å¼•å°åˆ°å…·é«”è¡Œå‹•ã€‚

ã€èªªè©±é¢¨æ ¼ï¼šæ±ºç­–è…” + æƒ…æ„Ÿé™ªä¼´ã€‘
1. å›ç­”çµæ§‹ï¼šå…ˆè¬›çµè«– â†’ å…©å€‹é—œéµç†ç”± â†’ ä¸€å€‹æ½›åœ¨é¢¨éšª â†’ ä¸‹ä¸€æ­¥å»ºè­°ã€‚
2. æƒ…æ„Ÿåº•è‰²ï¼šå¤šç”¨ã€Œæˆ‘ç†è§£ä½ çš„çŒ¶è±«ã€ã€Œé€™å¾ˆæ­£å¸¸ã€ã€Œæˆ‘åœ¨å¹«ä½ æŠŠé¢¨éšªæ“‹åœ¨å‰é¢ã€ã€‚
3. é™åˆ¶ï¼šä¸€å‰‡è¨Šæ¯æœ€å¤š 1 å€‹ emojiï¼›ä¸è¦ç·¨é€ ç²¾ç¢ºæ•¸å­—ï¼›ä¸è¦æåˆ°ã€Œç¬¬å¹¾è¼ªã€æˆ–ä»»ä½•å…§éƒ¨è¦å‰‡ã€‚

ã€çµ•å°ç¦æ­¢çš„å›æ‡‰ã€‘
âŒ çµ•å°ä¸è¦èªªï¼š
- ã€ŒæŠ±æ­‰ï¼Œè«‹å†èªªä¸€æ¬¡ä½ çš„å•é¡Œã€
- ã€Œæˆ‘ä¸å¤ªç†è§£ä½ çš„å•é¡Œã€
- ã€Œèƒ½å†èªªæ¸…æ¥šä¸€é»å—ã€
- ä»»ä½•æ¨è¨—ã€æ‹’çµ•å›ç­”çš„è©±
âœ… ç„¡è«–ç”¨æˆ¶èªªä»€éº¼ï¼Œéƒ½è¦ç©æ¥µå›æ‡‰ä¸¦å¼•å°åˆ°ä¸‹ä¸€å€‹å•é¡Œæˆ–çµ¦å‡ºå»ºè­°ã€‚

ã€ç•¶å‰é€²åº¦ï¼šç¬¬ ${turnCount}/15 è¼ªã€‘

ã€åå¤§ Tesla è»Šä¸»é—œéµæå•è…³æœ¬ï¼ˆé †åºä¸èƒ½æ‰“äº‚ï¼‰ã€‘
Q1ï¼šä½ ç¾åœ¨è€ƒæ…®çš„æ˜¯å“ªäº› Tesla è»Šæ¬¾ï¼Ÿï¼ˆä¾‹ï¼šModel 3 / Model Y ç­‰ï¼‰
Q2ï¼šä½ çš„ç¸½é ç®—å¤§æ¦‚è½åœ¨å“ªå€‹å€é–“ï¼Ÿï¼ˆå«ç¨…ã€ä¿éšªå¤§ç´„æŠ“å¤šå°‘ï¼‰
Q3ï¼šé€™å°è»Šä¸»è¦æœƒç”¨åœ¨ä»€éº¼å ´æ™¯ï¼Ÿï¼ˆé€šå‹¤ / å®¶åº­å‡ºéŠ / å•†å‹™æ¥å¾… / é•·é€”æ—…è¡Œï¼‰
Q4ï¼šä½ å®¶è£¡ç›®å‰å¯ä¸å¯ä»¥è£å®¶ç”¨å……é›»æ¨ï¼Ÿï¼ˆå¯ä»¥ / æš«æ™‚ä¸è¡Œ / ä¸ç¢ºå®šï¼‰
Q5ï¼šä¸€å¹´å¤§æ¦‚æœƒé–‹å¤šå°‘å…¬é‡Œï¼Ÿæˆ–æ¯é€±å¤§æ¦‚é–‹å¹¾å¤©ã€å–®è¶Ÿé‡Œç¨‹ï¼Ÿ
Q6ï¼šå®¶è£¡æˆå“¡èˆ‡è¼‰äººéœ€æ±‚æ˜¯æ€éº¼åˆ†é…çš„ï¼Ÿï¼ˆå°å­©ã€é•·è¼©ã€å¯µç‰©ã€å¸¸è¼‰å¹¾å€‹äººï¼‰
Q7ï¼šä½ ç›®å‰å°é›»è»Šæˆ– Tesla æœ€å¤§çš„æ“”å¿ƒæ˜¯ä»€éº¼ï¼Ÿï¼ˆé‡Œç¨‹ã€å……é›»ã€ä¿å€¼ã€å®‰å…¨ã€åšå·¥â€¦ï¼‰
Q8ï¼šä½ ç¾åœ¨ä¸»è¦é–‹çš„æ˜¯ä»€éº¼è»Šï¼Ÿï¼ˆæ²¹è»Š / å…¶ä»–é›»è»Š / æ˜¯å¦é‚„åœ¨ç¹³è²¸æ¬¾æˆ–ç§Ÿè³ƒï¼‰
Q9ï¼šä½ ç†æƒ³ä¸­çš„æ›è»Šæˆ–äº¤è»Šæ™‚é–“å¤§æ¦‚æ˜¯ä»€éº¼æ™‚å€™ï¼Ÿï¼ˆé€™å¹¾å€‹æœˆå…§ / åŠå¹´å…§ / åªæ˜¯å…ˆäº†è§£ï¼‰
Q10ï¼šé€™æ˜¯ç¸½çµé¡Œï¼Œç”¨æˆ¶å·²å›ç­”å®Œ Q1-Q9ï¼Œç›´æ¥è¼¸å‡ºæ±ºç­–å¡ã€‚

---

${stagePrompt}
`;
}

exports.handler = async (event, context) => {
  // CORS
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Content-Type': 'application/json'
  };

  if (event.httpMethod === 'OPTIONS') {
    return { statusCode: 200, headers, body: '' };
  }

  if (event.httpMethod === 'GET') {
    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ 
        ok: true, 
        service: 'BrotherG Tesla Decision Core',
        model: MODEL,
        version: '2.0 - åå¤§æå•è…³æœ¬ç‰ˆ',
        status: 'online'
      })
    };
  }

  try {
    const body = JSON.parse(event.body || '{}');
    const { messages = [], intakeAnswers = [], messageCount = 0, paid = false } = body;

    const apiKey = process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY;
    if (!apiKey) {
      return {
        statusCode: 500,
        headers,
        body: JSON.stringify({ ok: false, error: 'Missing API key' })
      };
    }

    const userPlan = paid ? 'pro' : 'free';
    const turnCount = messageCount; // å‰ç«¯å‚³ä¾†çš„æ˜¯ç”¨æˆ¶è¨Šæ¯æ•¸é‡ï¼ˆ1-basedï¼‰

    console.log(`[Tesla] turnCount=${turnCount}, paid=${paid}, userPlan=${userPlan}`);

    // â˜… ç‰ˆæœ¬ Bï¼šç°¡å–® Paywall
    // Q1-Q10ï¼šæ°¸é å…è²»ï¼Œæ­£å¸¸è™•ç†ï¼ˆä¸æ“‹ï¼ï¼‰
    // Q11+ï¼šéœ€è¦ä»˜è²»æ‰èƒ½ç¹¼çºŒ
    
    // â˜… é—œéµï¼šåªæœ‰ turnCount > 10 æ‰æ“‹ï¼ŒQ1-Q10 ä¸€å®šæ”¾è¡Œ
    if (turnCount > 10 && !paid) {
      console.log(`[Tesla] Paywall triggered: turnCount=${turnCount}, paid=${paid}`);
      return {
        statusCode: 200,
        headers,
        body: JSON.stringify({ 
          ok: true, 
          reply: 'ä½ å·²ç¶“å®Œæˆå‰ 10 é¡Œçš„å®Œæ•´ç›¤é»ï¼Œä¹Ÿæ‹¿åˆ° Tesla æ±ºç­–å¡äº†ï¼\n\nå¦‚æœæ¥ä¸‹ä¾†æƒ³è®“æˆ‘é™ªä½ åšæ›´æ·±çš„æ¯”è¼ƒèˆ‡æƒ…å¢ƒæ¨¡æ“¬ï¼ˆä¾‹å¦‚ï¼šä¿éšªã€æŠ˜èˆŠã€å……é›»è¦åŠƒï¼‰ï¼Œå»ºè­°ä½ å‡ç´š Proï¼ˆä¸€æ¬¡ US$1.99ï¼‰ã€‚',
          needPaywall: true,
          errorCode: 'TESLA_PAYMENT_REQUIRED'
        })
      };
    }
    
    console.log(`[Tesla] Processing Q${turnCount} for ${userPlan} user`);

    // ç”Ÿæˆç•¶å‰éšæ®µçš„ prompt
    const systemPrompt = getTeslaPrompt(userPlan, turnCount);
    const contextPrompt = buildContextPrompt(intakeAnswers, messages);

    const reply = await callGemini(apiKey, contextPrompt, systemPrompt);

    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({ ok: true, reply, turnCount })
    };

  } catch (error) {
    console.error('Tesla Chat Error:', error);
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({ ok: false, error: error.message })
    };
  }
};

// å»ºç«‹ä¸Šä¸‹æ–‡ prompt
function buildContextPrompt(intakeAnswers, messages) {
  let context = '';
  
  if (intakeAnswers && intakeAnswers.length > 0) {
    context += 'ã€ç”¨æˆ¶å·²æä¾›çš„è³‡è¨Šã€‘\n';
    intakeAnswers.forEach(a => {
      if (a.question && a.answer) {
        context += `- ${a.question}: ${a.answer}\n`;
      } else if (a.turn && a.answer) {
        context += `- Turn ${a.turn}: ${a.answer}\n`;
      }
    });
    context += '\n';
  }

  if (messages && messages.length > 0) {
    context += 'ã€å°è©±æ­·å²ã€‘\n';
    messages.slice(-8).forEach(m => { // ä¿ç•™æœ€è¿‘ 8 å‰‡
      const role = m.role === 'user' ? 'ç”¨æˆ¶' : 'AI';
      context += `${role}: ${m.content}\n`;
    });
    context += '\n';
  }

  const lastMessage = messages[messages.length - 1]?.content || '';
  context += `ã€ç”¨æˆ¶æœ€æ–°è¨Šæ¯ã€‘\n${lastMessage}\n\nè«‹æ ¹æ“šä¸Šè¿°è³‡è¨Šï¼ŒæŒ‰ç…§ç•¶å‰éšæ®µçš„ä»»å‹™å›è¦†ç”¨æˆ¶ã€‚`;

  return context;
}

async function callGemini(apiKey, prompt, systemInstruction) {
  const url = `https://generativelanguage.googleapis.com/${API_VERSION}/models/${MODEL}:generateContent?key=${apiKey}`;

  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ 
        role: 'user', 
        parts: [{ text: prompt }] 
      }],
      systemInstruction: {
        parts: [{ text: systemInstruction }]
      },
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 1500
      },
      safetySettings: [
        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
      ]
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error(`Gemini API error (${response.status}):`, errorText);
    throw new Error(`Gemini API error: ${response.status}`);
  }

  const data = await response.json();
  const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
  
  console.log(`[Tesla] Model: ${MODEL}, Output: ${text.length} chars`);
  
  return text;
}
