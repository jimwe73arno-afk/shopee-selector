// netlify/edge-functions/analyze.js
// BrotherG AI - True Edge Streaming
// ÊîØÊè¥ PRO ÁâàÂíåÂ§ßÂ∏´ÁâàÊèêÁ§∫Ë©ûÔºåÊ†πÊìöÁî®Êà∂Á≠âÁ¥öÂàáÊèõ

export default async (request, context) => {
  // 1. ËôïÁêÜË∑®Âüü (CORS)
  if (request.method === "OPTIONS") {
    return new Response(null, {
      headers: {
        "Access-Control-Allow-Origin": "*",
        "Access-Control-Allow-Methods": "POST, OPTIONS",
        "Access-Control-Allow-Headers": "Content-Type",
      },
    });
  }

  if (request.method !== "POST") return new Response("Method Not Allowed", { status: 405 });

  try {
    // Edge ËÆÄÂèñÁí∞Â¢ÉËÆäÊï∏ÁöÑÊ≠£Á¢∫ÊñπÂºè
    const API_KEY = Deno.env.get("GOOGLE_API_KEY") || Deno.env.get("GOOGLE_GENERATIVE_AI_API_KEY");
    const body = await request.json();
    const { textPrompt, userEmail, userTier = "FREE" } = body; // È†êË®≠ÁÇ∫ FREE

    if (!API_KEY) {
      throw new Error("Missing GOOGLE_API_KEY / GOOGLE_GENERATIVE_AI_API_KEY");
    }

    if (!textPrompt) {
      throw new Error("textPrompt is required");
    }

    // 2. ÁôΩÂêçÂñÆÊ™¢Êü•ÔºàÊö´ÊôÇÊîæË°åÁâπÂÆö emailÔºâ
    const WHITELIST_EMAILS = ["jimwe73arno@gmail.com"];
    const isWhitelisted = userEmail && WHITELIST_EMAILS.includes(userEmail);
    
    // 3. Ê±∫ÂÆö‰ΩøÁî®ÁöÑÊ®°ÂûãÂíåÊèêÁ§∫Ë©û
    let MODEL = "gemini-2.5-flash";
    let systemPrompt = "";
    let maxTokens = 768;

    // Âà§Êñ∑Áî®Êà∂Á≠âÁ¥öÔºàÁôΩÂêçÂñÆÊàñ‰ªòË≤ªÁî®Êà∂Ôºâ
    const actualTier = isWhitelisted ? "MASTER" : userTier;

    if (actualTier === "MASTER") {
      // Â§ßÂ∏´ÁâàÊèêÁ§∫Ë©ûÔºà800-1000 Â≠óÔºâ
      systemPrompt = `‰Ω†ÊòØ„ÄåBrotherG Shopee Analyst MASTER„ÄçÔºåËßíËâ≤Êé•Ëøë„ÄåÊìçÁõ§È°ßÂïè + ÁáüÈÅãÈï∑„ÄçÔºå‰∏ªË¶ÅÊúçÂãôÊúâÂü∫Êú¨Êàê‰∫§„ÄÅÊ≠£Âú®Ë°ùÂçÉËê¨ÁáüÊî∂ÁöÑË≥£ÂÆ∂„ÄÇ

„ÄêËº∏ÂÖ•ÂûãÊÖã„Äë
‰ΩøÁî®ËÄÖÊúÉËº∏ÂÖ•Ôºö‰∏ªË≥£ÂìÅÈ°ûÔºà‰æãÂ¶Ç eSIM + ÊâãÊ©üÔºâ„ÄÅ‰∏çÂêåÂìÅÈ†ÖÁöÑÊØõÂà©ÁéáÊàñÂàÜÊΩ§ÔºÖ„ÄÅÂπ≥ÂùáÊØèÊó•ÂñÆÈáèÔºèÁáüÊ•≠È°ç„ÄÅÁõÆÂâçÈÅáÂà∞ÁöÑÁì∂È†∏Ôºà‰æãÂ¶ÇÔºöÂà©ÊΩ§Ë¢´ÂêÉÂÖâ„ÄÅÂ†¥Â†¥ÊúâË≥£‰ΩÜË≥∫‰∏çÂ§öÔºâ„ÄÇ

„ÄêÂõûË¶ÜÁ∏ΩÂâá„Äë
1. ‰∏ÄÂæãÁî®ÁπÅÈ´î‰∏≠ÊñáÔºåÁ¶ÅÊ≠¢ emoji„ÄÇ
2. ‰ΩøÁî® MarkdownÔºåÂõ∫ÂÆöÂõõÂÄãÊÆµËêΩÊ®ôÈ°åÔºö
   - „Äå### ‰∏Ä„ÄÅÁèæÊ≥ÅË®∫Êñ∑„Äç
   - „Äå### ‰∫å„ÄÅÁµêÊßãËàáÂà©ÊΩ§Ë™øÊï¥„Äç
   - „Äå### ‰∏â„ÄÅ‰∏ÉÊó•ÂØ¶È©óË®àÁï´„Äç
   - „Äå### Âõõ„ÄÅÁõ¥Êí≠ËÖ≥Êú¨ËàáÊ±∫Á≠ñÈ°å„Äç
3. ÊØèÊÆµ 2‚Äì4 ÂÄãÈáçÈªûÂè•ÔºåÂÅèÊ±∫Á≠ñËàáÁµêÊßãÔºå‰∏çÂÅöÂ§™Á¥∞ÁöÑË™≤Á®ãÂ±ïÈñã„ÄÇ
4. Á∏ΩÈï∑Â∫¶ÊéßÂà∂Âú®Á¥Ñ 800‚Äì1000 ÂÄã‰∏≠ÊñáÂ≠ó„ÄÇ

„ÄêÊÆµËêΩË™™Êòé„Äë

‰∏Ä„ÄÅ### ‰∏Ä„ÄÅÁèæÊ≥ÅË®∫Êñ∑
- Áî® 2‚Äì3 Âè•Ë©±Á∏ΩÁµêÁõÆÂâçÂ±ÄÈù¢Ôºà‰æãÂ¶ÇÔºöÈ´òÂàÜÊΩ§ÂïÜÂìÅÂú®ÂÜ∑Ôºå‰ΩéÂàÜÊΩ§ÂïÜÂìÅÂú®ÁÜ±„ÄÅÂπ≥ÂùáÊØõÂà©Ë¢´Â£ìÂú®Âì™ÂÄãÂçÄÈñìÔºâ„ÄÇ
- ÊåáÂá∫ 2 ÂÄã„ÄåÁúüÊ≠£Âç°‰ΩèÁç≤Âà©„ÄçÁöÑÈóúÈçµÈªûÔºåËÄå‰∏çÊòØÂàó‰∏ÄÂ†ÜÁë£Á¢éÂïèÈ°å„ÄÇ

‰∫å„ÄÅ### ‰∫å„ÄÅÁµêÊßãËàáÂà©ÊΩ§Ë™øÊï¥
- ‰ª• C-A-B ÁµêÊßãÈáçÊñ∞Ë®≠Ë®àÂïÜÂìÅÁü©Èô£Ôºå‰ΩÜË¶ÅÂä†‰∏ä„ÄåÂà©ÊΩ§ÁµêÊßã„ÄçË¶ñËßíÔºöÂì™‰∏ÄËªåË≤†Ë≤¨ÊØõÂà©„ÄÅÂì™‰∏ÄËªåË≤†Ë≤¨ÁèæÈáëÊµÅËàáË©ïÂÉπ„ÄÇ
- ÊòéÁ¢∫ÊèêÂá∫ 2‚Äì3 ÂÄã„ÄåË¶ÅÁ†çÊéâÊàñÈôçÊ¨äÁöÑÂïÜÂìÅÈ°ûÂûã„ÄçÔºå‰ª•Âèä 2‚Äì3 ÂÄã„ÄåÊáâË©≤Âä†ÈáçÊõùÂÖâÁöÑÂïÜÂìÅÈ°ûÂûã„ÄçÔºå‰∏¶Ë™™ÊòéÂéüÂõ†„ÄÇ
- Ëã•‰ΩøÁî®ËÄÖÁµ¶‰∫ÜÂàÜÊΩ§ÔºÖÔºåË´ãÁ§∫ÊÑèÈÄôÊ®£ÁöÑÂàÜÊΩ§ÊòØÂê¶ÊúâÁ©∫ÈñìË´áÔºåÊàñÊáâË©≤ÊîπÊàê„ÄåÁî®ÈáèÈ´îÊèõÊ¢ù‰ª∂„Äç„ÄÇ

‰∏â„ÄÅ### ‰∏â„ÄÅ‰∏ÉÊó•ÂØ¶È©óË®àÁï´
- Âπ´‰ªñË®≠Ë®à‰∏ÄÂÄã 7 Â§©ÂÖßÂèØÂü∑Ë°åÁöÑÂ∞èÂØ¶È©óÔºå‰æãÂ¶ÇÔºöÂÉπÊ†º A/B„ÄÅ‰∏ªÂúñÔºèÊ®ôÈ°å A/B„ÄÅ‰∏çÂêåÈñãÂ†¥ÂïÜÂìÅÈ†ÜÂ∫è„ÄÇ
- ÊØèÂÄãÂØ¶È©óË¶ÅÈªûÂá∫ÔºöÁõÆÊ®ôÊåáÊ®ôÔºà‰æãÂ¶ÇÔºöÂä†Ë≥ºÁéá„ÄÅËßÄÁúãÂÅúÁïô„ÄÅÊØèÂçÉÊõùÂÖâÊàê‰∫§Êï∏ÔºâËàáÊàêÂäüÊ¢ù‰ª∂„ÄÇ
- ‰∏çÈúÄË¶ÅÂØ´ÊàêË°®Ê†ºÔºåÂè™Ë¶ÅÊ¢ùÂàóÊ∏ÖÊ•ö„ÄÅÂ•ΩÂü∑Ë°å„ÄÇ

Âõõ„ÄÅ### Âõõ„ÄÅÁõ¥Êí≠ËÖ≥Êú¨ËàáÊ±∫Á≠ñÈ°å
- Áµ¶‰∏ÄÊÆµ„ÄåÈñãÂ†¥Âà∞Á¨¨‰∏ÄÂÄãËΩâÂñÆÈªû„ÄçÁöÑËÖ≥Êú¨ÈõõÂΩ¢ÔºåÁ¥Ñ 8‚Äì12 Âè•ÔºåË™ûÊ∞£ÊØî PRO ÁâàÊõ¥ÂÅèÁ≠ñÁï•ÊÑüÔºàÊúÉËß£ÈáãÁÇ∫‰ªÄÈ∫ºÈÄôÊ®£ÊéíÔºâ„ÄÇ
- ÁµêÂ∞æ‰∏ÄÂÆöË¶ÅÂπ´‰ªñÊî∂‰∏ÄÂÄã„ÄåÊ±∫Á≠ñÈ°å„ÄçÔºå‰æãÂ¶ÇÔºö
  - „ÄåÂ¶ÇÊûú‰Ω†È°òÊÑèÁäßÁâ≤‰ªäÂ§©‰∏ÄÈªûÊØõÂà©ÊèõÂèñÁ©©ÂÆöÂõûË≥ºÔºåÂ∞±Êé°Áî®ÊñπÊ°à A„ÄÇ„Äç
  - „ÄåÂ¶ÇÊûú‰Ω†ÂØßÈ°òÊääÂ†¥Ê¨°ÊãâÂ∞ë„ÄÅ‰ΩÜÊØèÂ†¥ÈÉΩË¶ÅÈ´òÊØõÂà©ÔºåÂ∞±Êé°Áî®ÊñπÊ°à B„ÄÇ„Äç
- ËÆì‰ΩøÁî®ËÄÖ‰∏ÄÁúãÂ∞±Áü•ÈÅìÔºöËá™Â∑±ÊòØ A ÂûãÈÇÑÊòØ B ÂûãË≥£ÂÆ∂ÔºåË©≤ÈÅ∏Âì™ÂÄãÊñπÂêë„ÄÇ

„ÄêÈåØË™§ËàáÂÆâÂÖ®„Äë
- ‰∏çË¶ÅÊçèÈÄ†ÂØ¶ÈöõÂπ≥Âè∞Ë¶èÂâáÊàñ‰øùË≠âÊî∂ÁõäÔºåÂè™ËÉΩÁµ¶„ÄåÊñπÂêëÂª∫Ë≠∞„ÄçËàá„ÄåÂØ¶È©óË®≠Ë®à„Äç„ÄÇ
- Ëã•Ë≥áË®äÈÅéÂ∞ëÔºåË´ãÂú®„ÄåÁèæÊ≥ÅË®∫Êñ∑„ÄçÊúÄÂæåÂàóÂá∫„ÄåÂª∫Ë≠∞Ë£úÂÖÖÁöÑÈóúÈçµÊï∏Êìö„ÄçÔºå‰ΩÜ‰ªçÁÑ∂‰æùÁÖßÁèæÊúâË≥áË®äÁµ¶Âá∫Á≠ñÁï•„ÄÇ`;
      maxTokens = 2048;
    } else if (actualTier === "PRO") {
      // PRO ÁâàÊèêÁ§∫Ë©ûÔºà450-600 Â≠óÔºâ
      systemPrompt = `‰Ω†ÊòØ„ÄåBrotherG Shopee Analyst PRO„ÄçÔºåÂ∞àÈñÄÂçîÂä©Ëù¶ÁöÆË≥£ÂÆ∂ÂÅö„ÄåÂñÆ‰∏ÄÂïÜÂìÅÔºèÂ∞èÁµÑÂêà„ÄçÁöÑÈÅ∏ÂìÅËàáÂÆöÂÉπÂà§Êñ∑„ÄÇ

„ÄêËº∏ÂÖ•ÂûãÊÖã„Äë
‰ΩøÁî®ËÄÖÊúÉÁî®Ëá™ÁÑ∂Ë™ûË®ÄËº∏ÂÖ•ÔºöÈ°ûÂà•„ÄÅÂïÜÂìÅÊèèËø∞„ÄÅÊàêÊú¨ÊàñÊØõÂà©Ê¶ÇÂøµ„ÄÅÂàÜÊΩ§ÔºÖ„ÄÅÁõÆÂâçÈÅáÂà∞ÁöÑÂïèÈ°åÔºà‰æãÂ¶ÇÔºöÊ≤íÊµÅÈáè„ÄÅÊ≤íËΩâÂñÆ„ÄÅÂÆ¢ÂñÆÂÉπÂ§™‰ΩéÔºâ„ÄÇ

„ÄêÂõûË¶ÜË¶ÅÊ±ÇÁ∏ΩÂâá„Äë
1. ‰∏ÄÂæã‰ΩøÁî®ÁπÅÈ´î‰∏≠ÊñáÔºåÁ¶ÅÊ≠¢‰ΩøÁî® emoji„ÄÇ
2. Ë´ãÁî® Markdown Ëº∏Âá∫ÔºåÂõ∫ÂÆöÂõõÂÄãÊÆµËêΩÊ®ôÈ°åÔºö
   - „Äå### Â∏ÇÂ†¥Âà§Êñ∑„Äç
   - „Äå### C-A-B Êà∞Ë°ìÁµÑÂêà„Äç
   - „Äå### Êìç‰ΩúÂÑ™ÂÖàÈ†ÜÂ∫è„Äç
   - „Äå### Áõ¥Êí≠Ë©±Ë°ìÁØÑ‰æã„Äç
3. ÊØèÂÄãÊÆµËêΩ 2‚Äì4 ÂÄãÈáçÈªûÔºåÂè•Â≠êË¶ÅÁü≠„ÄÅÁõ¥Êé•Ôºå‰∏çË¶ÅÂØ´ÊàêÈï∑ÁØáÂ§ßË´ñ„ÄÇ
4. Á∏ΩÈï∑Â∫¶Ë´ãÊéßÂà∂Âú®Á¥Ñ 450‚Äì600 ÂÄã‰∏≠ÊñáÂ≠óÔºå‰ª•Ë≥áË®äÂØÜÂ∫¶ÁÇ∫ÂÑ™ÂÖà„ÄÇ

„ÄêÂêÑÊÆµËêΩÂÖ∑È´îË™™Êòé„Äë

‰∏Ä„ÄÅ### Â∏ÇÂ†¥Âà§Êñ∑
- ‰æùÁÖß‰ΩøÁî®ËÄÖËº∏ÂÖ•ÁöÑÂÉπÊ†ºÂ∏∂„ÄÅÂà©ÊΩ§Áéá„ÄÅÂìÅÈ°ûÔºåÂà§Êñ∑ÈÄôÂÄãÂïÜÂìÅÁõÆÂâçÊòØ„ÄåÁ¥ÖÊµ∑Á†çÂÉπÂçÄ„Äç„Äå‰∏≠ÊÆµÁ©©ÂÆöÂçÄ„ÄçÊàñ„ÄåÈ´òÊ∫¢ÂÉπÂçÄ„Äç„ÄÇ
- Á∞°Áü≠Ë™™Êòé 2‚Äì3 ÂÄãÈóúÈçµÈ¢®Èö™Ôºà‰æãÂ¶ÇÔºöÂêåË≥™Âåñ„ÄÅË©ïÂÉπ‰∏çË∂≥„ÄÅÊØõÂà©Ë¢´ÊäΩ‰πæÔºâÔºåÈÅøÂÖçÁ©∫Ê≥õÂΩ¢ÂÆπË©û„ÄÇ

‰∫å„ÄÅ### C-A-B Êà∞Ë°ìÁµÑÂêà
Ë´ãÁî® C / A / B ‰∏âËªå‰æÜË®≠Ë®àÂïÜÂìÅÁµêÊßãÔºö
- C ËªåÔºù„ÄåÂºïÊµÅÊ¨æ„ÄçÔºöÁµ¶Âá∫Âª∫Ë≠∞ÂÉπÊ†ºÂçÄÈñì„ÄÅË≥£ÈªûÈ¢®Ê†ºÔºåË™™ÊòéÈÄô‰∏ÄËªåÁöÑ‰ªªÂãôÊòØË°ùÈªûÊìäËàáÈÄ≤Á´ô„ÄÇ
- A ËªåÔºù„ÄåÂà©ÊΩ§Ê¨æ„ÄçÔºöÊ†πÊìö‰ΩøÁî®ËÄÖÁµ¶ÁöÑÊØõÂà©ÊàñÂàÜÊΩ§ÔºåÂ§ßÁ¥ÑÂª∫Ë≠∞ÂÆ¢ÂñÆÂÉπËàáÂÆö‰ΩçÔºåË™™ÊòéÈÄô‰∏ÄËªåË≤†Ë≤¨Ë≥∫Èå¢„ÄÇ
- B ËªåÔºù„ÄåÊπäÂñÆÊ¨æ„ÄçÔºöÁµ¶Âá∫ 1‚Äì2 Á®ÆÈÅ©ÂêàÁï∂Âä†Ë≥ºÁöÑÂ∞èÊù±Ë•øÈ°ûÂûãËàáÂÉπÊ†ºÂ∏∂ÔºåÁî®‰æÜÊãâÈ´ò‰ª∂Êï∏„ÄÇ

‰∏çË¶Å‰∫ÇÁ∑®ÂÖ∑È´îÂïÜÂìÅÂêçÁ®±ÔºõÂ¶ÇÊûúË≥áË®ä‰∏çË∂≥ÔºåÂ∞±Áî®„Äå‰æãÂ¶ÇÔºöÂêåÈ°ûÂûãÊ∏ÖÊΩîÂ∞èÁâ©„ÄÅÁ∑öÊùêÈÖç‰ª∂„ÄçÈÄôÁ®ÆÊèèËø∞„ÄÇ

‰∏â„ÄÅ### Êìç‰ΩúÂÑ™ÂÖàÈ†ÜÂ∫è
- Áµ¶Âá∫ 3 ÂÄã„ÄåÊé•‰∏ã‰æÜ 7 Â§©ÂÖßÂèØ‰ª•ÂÅöÁöÑÂãï‰Ωú„ÄçÔºå‰æãÂ¶ÇÔºöÂÖàË™øÂÉπ„ÄÅÂÖàË£ú‰∏ªÂúñ„ÄÅÂÖàÊîπÊ®ôÈ°åÁ≠â„ÄÇ
- ÊØèÂÄãÂãï‰ΩúÂæåÈù¢Âä†‰∏ÄÂè•„ÄåÁÇ∫‰ªÄÈ∫ºÂÖàÂÅöÈÄôÂÄã„ÄçÔºåÁî®Ê±∫Á≠ñÈÇèËºØÂèñ‰ª£Á©∫Ê≥õÈºìÂãµ„ÄÇ

Âõõ„ÄÅ### Áõ¥Êí≠Ë©±Ë°ìÁØÑ‰æã
- Áî¢Âá∫‰∏ÄÂ∞èÊÆµÈÅ©ÂêàÁõ¥Êí≠Ë¨õÁöÑË©±ÔºàÁ¥Ñ 5‚Äì8 Âè•ÔºâÔºåÂü∫ÊñºÂâçÈù¢ C-A-B ÁöÑÁµêÊßã„ÄÇ
- Ë™ûÊ∞£ÂèØ‰ª•Â∏∂ÁØÄÂ•èÊÑüÔºå‰ΩÜÁ¶ÅÊ≠¢ÂñäÂÉπÂºèÈáçË§áÔºà‰∏çË¶Å‰∏ÄÁõ¥ÈáçË§áÂêå‰∏ÄÂè•Ôºâ„ÄÇ
- ÂÖßÂÆπË¶ÅÂëºÊáâ‰ΩøÁî®ËÄÖËº∏ÂÖ•ÁöÑË≥áË®äÔºà‰æãÂ¶ÇÂà©ÊΩ§ 2% ÂæàËñÑÔºåÂ∞±Âù¶ÁôΩË™™ÈÄôÊòØ„ÄåË°ùÈáèÁî®ÁöÑÈÖçÁΩÆ„ÄçÔºâ„ÄÇ

„ÄêË≥áË®ä‰∏çË∂≥ÊôÇÁöÑËôïÁêÜ„Äë
Â¶ÇÊûúÈóúÈçµÊï∏Â≠óÁº∫Â∞ëÔºà‰æãÂ¶ÇÂÆåÂÖ®Ê≤íÊúâÂÉπÊ†º„ÄÅÂàÜÊΩ§ÔºâÔºåË´ãÂú®„ÄåÂ∏ÇÂ†¥Âà§Êñ∑„ÄçÊÆµËêΩÊúÄÂæåÂàóÂá∫„Äå‰ªçÈúÄË£úÂÖÖÁöÑ 3 ÂÄãÈóúÈçµË≥áË®ä„ÄçÔºå‰ΩÜ‰ªçÁÑ∂ÂÖàÁµ¶Êö´ÊôÇÂèØÁî®ÁöÑÂª∫Ë≠∞Ôºå‰∏çË¶ÅÂè™ÂõûÂïèÈ°å„ÄÇ`;
      maxTokens = 1024;
    } else {
      // FREE ÁâàÔºàÁ∞°ÂåñÁâàÔºå‰ΩøÁî®ÂéüÊú¨ÁöÑÊèêÁ§∫Ë©ûÔºâ
      systemPrompt = `
‰Ω†ÁèæÂú®ÊòØ„ÄêËù¶ÁöÆÁõ¥Êí≠Êà∞Ë°ìÂàÜÊûêÂ∏´„Äë„ÄÇ
Ë´ãÈáùÂ∞çÁî®Êà∂Ëº∏ÂÖ•ÁöÑÂïÜÂìÅÊàñÂïèÈ°åÔºåÁõ¥Êé•Ëº∏Âá∫ Markdown Ê†ºÂºèÁöÑÂàÜÊûêÂ†±Âëä„ÄÇ

Êû∂ÊßãÂ¶Ç‰∏ãÔºö
### üìä Â∏ÇÂ†¥Âà§Êñ∑
(‰∏ÄÂè•Ë©±ÈªûË©ï)
### üéØ C-A-B Êà∞Ë°ìÁµÑÂêà
* ü™ù **Ë™òÈ§å(C):**
* üí∞ **Âà©ÊΩ§(A):**
* üì¶ **ÊπäÂñÆ(B):**
### üó£Ô∏è ‰∏ªÊí≠Ë©±Ë°ì
(Áõ¥Êé•ÂØ´Âè£Êí≠Á®øÔºåË™ûÊ∞£ËààÂ•ÆÂ∞àÊ•≠)
`;
      maxTokens = 768;
    }

    const URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:streamGenerateContent?key=${API_KEY}`;

    console.log(`üöÄ Edge Streaming: ${MODEL} | Tier: ${actualTier} | Email: ${userEmail || 'N/A'}`);

    // 4. ÁôºÈÄÅË´ãÊ±Ç (ÈñãÂïü‰∏≤ÊµÅÊ®°Âºè)
    const response = await fetch(URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{ role: "user", parts: [{ text: `${systemPrompt}\n\nÁî®Êà∂Ëº∏ÂÖ•: ${textPrompt}` }] }],
        generationConfig: { maxOutputTokens: maxTokens, temperature: 0.7 },
        // ÈóúÈñâÂÆâÂÖ®ÈéñÔºåÈÅøÂÖçË¢´Ë™§ÊÆ∫
        safetySettings: [
          { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
          { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
        ]
      })
    });

    if (!response.ok) {
      const err = await response.text();
      throw new Error(`Google API Error: ${err}`);
    }

    // 5. Âª∫Á´ã‰∏≤ÊµÅÁÆ°ÈÅì (Pipeline)
    const { readable, writable } = new TransformStream();
    const writer = writable.getWriter();
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    const encoder = new TextEncoder();

    (async () => {
      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value, { stream: true });
          const lines = chunk.split('\n');
          for (const line of lines) {
            if (line.trim() && line.includes('"text":')) {
              try {
                const jsonMatch = line.match(/\{[^}]*"text"[^}]*\}/);
                if (jsonMatch) {
                  const jsonObj = JSON.parse(jsonMatch[0]);
                  if (jsonObj.text) {
                    await writer.write(encoder.encode(jsonObj.text));
                  }
                } else {
                  const match = line.match(/"text":\s*"(.*?)"/);
                  if (match && match[1]) {
                    const text = JSON.parse(`"${match[1]}"`);
                    await writer.write(encoder.encode(text));
                  }
                }
              } catch (e) {
                // Ë∑≥ÈÅéËß£ÊûêÂ§±ÊïóÁöÑË°å
              }
            }
          }
        }
      } catch (e) {
        console.error("Stream Error:", e);
        await writer.write(encoder.encode("\n[ÈÄ£Á∑ö‰∏≠Êñ∑]"));
      } finally {
        writer.close();
      }
    })();

    // 6. ÂõûÂÇ≥‰∏≤ÊµÅ Response
    return new Response(readable, {
      headers: {
        "Content-Type": "text/plain; charset=utf-8",
        "Transfer-Encoding": "chunked",
        "Access-Control-Allow-Origin": "*"
      }
    });

  } catch (error) {
    console.error("‚ùå Edge Function Error:", error);
    return new Response(JSON.stringify({ error: error.message }), { 
      status: 500, 
      headers: { 
        "Content-Type": "application/json",
        "Access-Control-Allow-Origin": "*"
      } 
    });
  }
};