<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tesla æ±ºç­–é¡§å• | BrotherGAi</title>
    
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Rajdhani', 'sans-serif'] },
                    colors: { appBg: '#020617', appSurface: '#0F172A', primary: '#00A0E9' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #F8FAFC; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { display: none; }
        .app-shell { min-height: 100vh; min-height: 100dvh; display: flex; justify-content: center; align-items: center; background: #050816; }
        .app-phone-frame { width: 100%; max-width: 430px; height: 100vh; height: 100dvh; max-height: 932px; border-radius: 40px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); position: relative; }
        @media (max-width: 768px) { .app-shell { background: #020617; } .app-phone-frame { max-width: 100%; max-height: 100%; border-radius: 0; box-shadow: none; } }
        .touch-active:active { transform: scale(0.96); opacity: 0.8; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; font-size: 15px; line-height: 1.6; }
        .chat-bubble.ai { background-color: #1E293B; color: #F1F5F9; border-radius: 20px 20px 20px 4px; }
        .chat-bubble.user { background-color: #00A0E9; color: white; border-radius: 20px 20px 4px 20px; margin-left: auto; }
        .blue-filter { filter: brightness(0) saturate(100%) invert(55%) sepia(57%) saturate(2000%) hue-rotate(166deg) brightness(96%) contrast(101%); }
    </style>
</head>
<body>
<div class="app-shell">
<div class="app-phone-frame">
<div id="app-root" class="h-[100dvh] w-full flex flex-col overflow-hidden relative bg-appBg">

    <!-- ===== ç™»å…¥ç•«é¢ ===== -->
    <div id="login-view" class="absolute inset-0 z-50 bg-appBg flex flex-col items-center justify-center p-6">
        <div class="text-center max-w-sm">
            <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-primary/20 border border-primary/30 flex items-center justify-center">
                <img src="/modelx.png" alt="Tesla" class="w-14 h-14 object-contain blue-filter">
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Tesla æ±ºç­–é¡§å•</h1>
            <p class="text-slate-400 text-sm mb-8">ç™»å…¥å¾Œé–‹å§‹ä½ çš„è³¼è»Šè«®è©¢</p>
            <button onclick="handleGoogleLogin()" id="login-btn" class="w-full py-4 bg-white text-gray-800 font-bold rounded-2xl flex items-center justify-center gap-3 touch-active shadow-lg">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
            </button>
        </div>
    </div>

    <!-- ===== ä¸»ç•«é¢ ===== -->
    <div id="main-view" class="hidden flex-1 flex flex-col">
        
        <!-- Header -->
        <header class="bg-appBg/95 backdrop-blur-xl border-b border-slate-800 z-40" style="padding-top: env(safe-area-inset-top);">
            <div class="h-14 flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <a href="/"><img src="/logo.png" alt="BrotherG" class="w-8 h-8 rounded-lg"></a>
                    <span class="font-display font-bold text-lg text-white">Tesla é¡§å•</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="progress" class="text-xs font-medium text-slate-400 bg-slate-800 px-2 py-1 rounded-full">Q1/10</span>
                    <button onclick="handleLogout()" class="text-slate-500 text-sm"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
                </div>
            </div>
        </header>

        <!-- èŠå¤©å€åŸŸ -->
        <div id="chat-container" class="flex-1 overflow-y-auto px-4 py-4">
            <div id="chat-history" class="flex flex-col gap-4"></div>
        </div>

        <!-- è¼¸å…¥æ¡† -->
        <div id="input-bar" class="bg-appBg/95 backdrop-blur-xl border-t border-slate-800" style="padding-bottom: env(safe-area-inset-bottom);">
            <div class="p-3 flex items-center gap-3">
                <div class="flex-1 bg-appSurface rounded-full h-11 flex items-center px-4 border border-slate-700 focus-within:border-primary">
                    <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ..." 
                        class="bg-transparent border-none outline-none text-white text-sm w-full placeholder-slate-500" autocomplete="off">
                </div>
                <button id="send-btn" onclick="handleSubmit()" 
                    class="w-11 h-11 rounded-full bg-primary text-white flex items-center justify-center shadow-lg touch-active disabled:opacity-50">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== æœ€çµ‚æ±ºç­– Modal ===== -->
    <div id="final-modal" class="hidden fixed inset-0 z-60 bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-2xl p-6 text-gray-900">
            <h2 class="text-xl font-bold mb-4">ğŸ¯ ä»Šå¤©çš„ 10 é¡Œå·²å®Œæˆï¼</h2>
            <pre id="final-summary" class="whitespace-pre-wrap mb-6 text-sm bg-gray-50 p-4 rounded-lg border border-gray-200 font-sans"></pre>
            
            <button id="btn-referral" class="w-full py-3.5 bg-gray-900 text-white rounded-xl mb-3 touch-active font-medium">
                ä½¿ç”¨æˆ‘çš„ Tesla å°è³¼ç¢¼ï¼ˆå…è²»ï¼‰
            </button>
            
            <button id="btn-pay" class="w-full py-3.5 bg-red-500 text-white rounded-xl mb-3 touch-active font-medium">
                æ”¯ä»˜ US$1.99ï¼Œç²å¾—å®Œæ•´ Tesla æ±ºç­–å¡
            </button>
            
            <button id="btn-tomorrow" class="w-full py-3.5 bg-gray-200 text-gray-700 rounded-xl touch-active font-medium">
                å…ˆä¸ç”¨ï¼Œæˆ‘æ˜å¤©å†ä¾†å…è²» 10 é¡Œ
            </button>
        </div>
    </div>

    <!-- ===== æ±ºç­–å¡é¡¯ç¤º Modal ===== -->
    <div id="decision-card-modal" class="hidden fixed inset-0 z-70 bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-2xl p-6 text-gray-900 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">ğŸ¯ ä½ çš„ Tesla æ±ºç­–å¡</h2>
            <div id="decision-card-content" class="mb-6 text-sm whitespace-pre-wrap"></div>
            <button onclick="closeDecisionCard()" class="w-full py-3.5 bg-primary text-white rounded-xl touch-active font-medium">
                å®Œæˆ
            </button>
        </div>
    </div>

</div>
</div>
</div>

<script src="/js/firebase-store.js"></script>
<script>
// ===============================
// TESLA æ±ºç­–å™¨ï¼ˆä¹¾æ·¨æ­£å¼ç‰ˆï¼‰
// ===============================

// === å¸¸æ•¸ ===
const DAILY_FREE_QUESTIONS = 10;

// === ç‹€æ…‹ ===
let currentUser = null;
let currentQuestionIndex = 1;
let answers = [];
let inputDisabled = false;
let sessionId = null;

// === åå¤§å›ºå®šæå• ===
const scriptedQuestions = [
  "ä½ ç¾åœ¨åœ¨è€ƒæ…®å“ªæ¬¾ Teslaï¼Ÿ",
  "ä½ çš„ç¸½é ç®—å¤§æ¦‚è½åœ¨å“ªå€‹å€é–“ï¼Ÿï¼ˆå«ç¨…é‡‘ï¼‹ä¿éšªç²—æŠ“ï¼‰",
  "é€™å°è»Šä¸»è¦æœƒç”¨åœ¨ä»€éº¼å ´æ™¯ï¼Ÿï¼ˆé€šå‹¤ / å®¶åº­ / å•†å‹™ / é•·é€”æ—…è¡Œï¼‰",
  "ä½ å®¶è£¡ç›®å‰å¯ä¸å¯ä»¥å®‰è£å®¶ç”¨å……é›»æ¨ï¼Ÿï¼ˆå¯ä»¥ / ä¸èƒ½ / ä¸ç¢ºå®šï¼‰",
  "ä¸€å¹´å¤§æ¦‚é–‹å¹¾å…¬é‡Œï¼Ÿ",
  "ä½ çš„é•·é€”éœ€æ±‚æ˜¯å“ªäº›è·¯æ®µï¼Ÿï¼ˆä¾‹å¦‚ï¼šå°åŒ—â†”é«˜é›„ï¼‰",
  "ä½ ç›®å‰æ‰€åœ¨çš„åŸå¸‚ï¼åœ‹å®¶ï¼Ÿ",
  "ä½ æ›´åœ¨æ„ä»€éº¼ï¼Ÿï¼ˆå®‰å…¨ / æ€§èƒ½ / èˆ’é© / ç©ºé–“ / å“ç‰Œï¼‰",
  "ä½ ç¾åœ¨æœ‰æ²’æœ‰èˆŠè»Šè¦è™•ç†ï¼Ÿ",
  "ä½ æ‰“ç®—ä»€éº¼æ™‚å€™ä¸‹æ±ºå®šï¼Ÿï¼ˆ1 å€‹æœˆ / 3 å€‹æœˆ / åŠå¹´ï¼‰",
];

// ===============================
// åˆå§‹åŒ–
// ===============================
function initTeslaApp() {
    if (!currentUser) return;
    
    updateQuestionUI();
    addBotMessage(scriptedQuestions[0]);
    
    // ç¶å®šäº‹ä»¶
    document.getElementById("user-input").addEventListener("keydown", async (e) => {
        if (e.key === "Enter" && !inputDisabled) {
            await handleSubmit();
        }
    });
    
    // æŒ‰éˆ•äº‹ä»¶
    document.getElementById("btn-referral").onclick = () => {
        window.open("https://ts.la/arno873937", "_blank");
    };
    
    document.getElementById("btn-pay").onclick = async () => {
        await handlePayment();
    };
    
    document.getElementById("btn-tomorrow").onclick = () => {
        window.location.href = "/";
    };
}

// ===============================
// ä¸»é‚è¼¯ï¼šé€å‡ºç­”æ¡ˆ
// ===============================
async function handleSubmit() {
    if (inputDisabled || !currentUser) return;

    const inputEl = document.getElementById("user-input");
    const userAnswer = inputEl.value.trim();
    if (!userAnswer) return;

    // 1. é¡¯ç¤ºç”¨æˆ¶ç­”æ¡ˆ
    addUserMessage(userAnswer);
    
    // 2. å„²å­˜ç­”æ¡ˆ
    answers.push({ questionId: currentQuestionIndex, answerText: userAnswer });

    // 3. ä¿å­˜åˆ°å¾Œç«¯
    try {
        const res = await fetch('/.netlify/functions/tesla-save-answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUser.uid,
                questionId: currentQuestionIndex,
                answerText: userAnswer,
                sessionId: sessionId
            })
        });
        const data = await res.json();
        if (data.ok && data.sessionId) {
            sessionId = data.sessionId;
        }
    } catch (e) {
        console.error('[Tesla] Save answer error:', e);
    }

    // 4. æ¸…é™¤è¼¸å…¥æ¡†
    inputEl.value = "";

    // 5. å¦‚æœé‚„æ²’é€²å…¥çµå°¾ â†’ é¡Œè™Ÿ +1
    if (currentQuestionIndex < DAILY_FREE_QUESTIONS) {
        currentQuestionIndex++;
        updateQuestionUI();
        addBotMessage(scriptedQuestions[currentQuestionIndex - 1]);
        return;
    }

    // 6. å¦‚æœé€™å°±æ˜¯ç¬¬ 10 é¡Œ â†’ é€²å…¥çµå°¾æµç¨‹
    if (currentQuestionIndex === DAILY_FREE_QUESTIONS) {
        inputDisabled = true;
        document.getElementById("user-input").disabled = true;
        document.getElementById("send-btn").disabled = true;
        showFinalDecisionModal();
    }
}

// ===============================
// UIï¼šæ›´æ–°å•é¡Œã€é€²åº¦
// ===============================
function updateQuestionUI() {
    document.getElementById("progress").innerText = `Q${currentQuestionIndex}/${DAILY_FREE_QUESTIONS}`;
}

function addBotMessage(text) {
    const chatHistory = document.getElementById("chat-history");
    const div = document.createElement("div");
    div.className = "flex items-end gap-2";
    div.innerHTML = `
        <div class="w-8 h-8 rounded-full flex-shrink-0 bg-slate-800 border border-slate-700 flex items-center justify-center">
            <img src="/logo.png" alt="AI" class="w-5 h-5">
        </div>
        <div class="chat-bubble ai">${escapeHtml(text)}</div>
    `;
    chatHistory.appendChild(div);
    scrollToBottom();
}

function addUserMessage(text) {
    const chatHistory = document.getElementById("chat-history");
    const div = document.createElement("div");
    div.className = "flex justify-end";
    div.innerHTML = `<div class="chat-bubble user">${escapeHtml(text)}</div>`;
    chatHistory.appendChild(div);
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById("chat-container");
    setTimeout(() => container?.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }), 100);
}

function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
}

// ===============================
// çµå°¾ï¼šå½ˆå‡ºæœ€çµ‚ä¸‰é¸ä¸€ Modal
// ===============================
function showFinalDecisionModal() {
    const modal = document.getElementById("final-modal");
    modal.classList.remove("hidden");
    
    // ç”¢ç”Ÿæ‘˜è¦
    const summary = generateConclusionCard();
    document.getElementById("final-summary").textContent = summary;
}

function generateConclusionCard() {
    return `ğŸ¯ ä½ çš„ Tesla æ±ºç­–æ‘˜è¦
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
è»Šå‹ï¼š${answers[0]?.answerText || ''}
é ç®—ï¼š${answers[1]?.answerText || ''}
å ´æ™¯ï¼š${answers[2]?.answerText || ''}
å®¶å……ï¼š${answers[3]?.answerText || ''}
é‡Œç¨‹ï¼š${answers[4]?.answerText || ''}
é•·é€”ï¼š${answers[5]?.answerText || ''}
åœ°å€ï¼š${answers[6]?.answerText || ''}
åå¥½ï¼š${answers[7]?.answerText || ''}
èˆŠè»Šï¼š${answers[8]?.answerText || ''}
æ±ºç­–æœŸï¼š${answers[9]?.answerText || ''}

ï¼ˆå¦‚æœä½ è¦å®Œæ•´ç‰ˆæœ¬ / PDF / é…ç½®å»ºè­° â†’ ä¸‹æ–¹ç¬¬äºŒå€‹æŒ‰éˆ• US$1.99ï¼‰`;
}

// ===============================
// ä»˜æ¬¾æµç¨‹
// ===============================
async function handlePayment() {
    const btn = document.getElementById("btn-pay");
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>è·³è½‰ PayPal...';
    btn.disabled = true;

    try {
        // 1. è§¸ç™¼ PayPal checkout
        const res = await fetch('/.netlify/functions/paypal-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product: 'BROTHERG_PRO',
                returnUrl: window.location.origin + '/payment/success?product=BROTHERG_PRO&return=/tesla-app&sessionId=' + sessionId,
                cancelUrl: window.location.origin + '/payment/cancel?product=BROTHERG_PRO&return=/tesla-app'
            })
        });
        const data = await res.json();
        if (data.ok && data.checkoutUrl) {
            window.location.href = data.checkoutUrl;
        } else {
            throw new Error('PayPal error');
        }
    } catch (e) {
        console.error('[Tesla] Payment error:', e);
        btn.innerHTML = 'æ”¯ä»˜ US$1.99ï¼Œç²å¾—å®Œæ•´ Tesla æ±ºç­–å¡';
        btn.disabled = false;
    }
}

// ===============================
// é¡¯ç¤ºæ±ºç­–å¡
// ===============================
async function showDecisionCard() {
    if (!sessionId || !currentUser) return;

    try {
        const res = await fetch('/.netlify/functions/tesla-payment-success', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: currentUser.uid,
                sessionId: sessionId
            })
        });
        const data = await res.json();
        
        if (data.ok && data.decisionCard) {
            document.getElementById("decision-card-content").textContent = data.decisionCard;
            document.getElementById("final-modal").classList.add("hidden");
            document.getElementById("decision-card-modal").classList.remove("hidden");
        }
    } catch (e) {
        console.error('[Tesla] Get decision card error:', e);
    }
}

function closeDecisionCard() {
    document.getElementById("decision-card-modal").classList.add("hidden");
    window.location.href = "/";
}

// ===============================
// Auth
// ===============================
async function handleGoogleLogin() {
    const btn = document.getElementById("login-btn");
    try {
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>é©—è­‰ä¸­...';
        btn.disabled = true;

        const result = await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
        currentUser = result.user;
        
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("main-view").classList.remove("hidden");
        
        initTeslaApp();
    } catch (err) {
        console.error('[Tesla] Login error:', err);
    } finally {
        btn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google"><span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>';
        btn.disabled = false;
    }
}

async function handleLogout() {
    try {
        await firebase.auth().signOut();
        currentUser = null;
        currentQuestionIndex = 1;
        answers = [];
        sessionId = null;
        inputDisabled = false;
        document.getElementById("chat-history").innerHTML = "";
        document.getElementById("login-view").classList.remove("hidden");
        document.getElementById("main-view").classList.add("hidden");
    } catch (e) {
        console.error('[Tesla] Logout error:', e);
    }
}

// ===============================
// æª¢æŸ¥ä»˜æ¬¾æˆåŠŸå›èª¿
// ===============================
window.onload = function() {
    // æª¢æŸ¥ URL åƒæ•¸
    const params = new URLSearchParams(window.location.search);
    const sessionIdParam = params.get('sessionId');
    
    if (sessionIdParam && params.get('paid') === 'true') {
        sessionId = sessionIdParam;
        // ç­‰å¾…ç™»å…¥å¾Œå†é¡¯ç¤ºæ±ºç­–å¡
        firebase.auth().onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById("login-view").classList.add("hidden");
                document.getElementById("main-view").classList.remove("hidden");
                await showDecisionCard();
            }
        });
    } else {
        // æ­£å¸¸åˆå§‹åŒ–
        firebase.auth().onAuthStateChanged((user) => {
            currentUser = user;
            if (user) {
                document.getElementById("login-view").classList.add("hidden");
                document.getElementById("main-view").classList.remove("hidden");
                initTeslaApp();
            }
        });
    }
};
</script>
</body>
</html>
