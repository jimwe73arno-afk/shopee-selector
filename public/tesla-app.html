<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#FFFFFF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Tesla æ±ºç­–é¡§å• | BrotherGAi</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        aiBlue: '#1E88E5',
                        bgPage: '#FFFFFF',
                        borderLight: '#E2E8F0',
                        textMain: '#111827',
                        textSub: '#64748B',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #FFFFFF; 
            color: #111827; 
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
        }
        
        ::-webkit-scrollbar { display: none; }

        /* === Desktop Phone Frame === */
        .app-shell {
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #050816;
        }

        .app-phone-frame {
            width: 100%;
            max-width: 430px;
            height: 100vh;
            height: 100dvh;
            max-height: 932px;
            border-radius: 40px;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
            position: relative;
            background: #FFFFFF;
        }

        @media (max-width: 768px) {
            .app-shell { background: #FFFFFF; }
            .app-phone-frame {
                max-width: 100%;
                max-height: 100%;
                border-radius: 0;
                box-shadow: none;
            }
        }
        
        /* Background Pattern */
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(#E5E7EB 1px, transparent 1px);
            background-size: 24px 24px; opacity: 0.4; z-index: -1; pointer-events: none;
        }

        /* Chat Bubbles */
        .chat-bubble {
            max-width: 85%;
            padding: 14px 18px;
            font-size: 15px;
            line-height: 1.6;
            position: relative;
        }
        .chat-bubble.ai {
            background-color: #F1F5F9;
            color: #111827;
            border-radius: 4px 20px 20px 20px;
        }
        .chat-bubble.user {
            background-color: #1E88E5;
            color: white;
            border-radius: 20px 4px 20px 20px;
            margin-left: auto;
        }

        /* Markdown in Chat */
        .chat-bubble.ai h3 {
            color: #1E88E5;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .chat-bubble.ai h3:first-child { margin-top: 0; }
        .chat-bubble.ai p { margin-bottom: 0.75rem; }
        .chat-bubble.ai ul { list-style: disc; padding-left: 1.2rem; margin-bottom: 0.75rem; }
        .chat-bubble.ai li { margin-bottom: 0.4rem; }
        .chat-bubble.ai strong { color: #111827; font-weight: 600; }
        .chat-bubble.ai a { color: #1E88E5; text-decoration: underline; }

        /* Typing Animation */
        .typing-dot {
            width: 6px; height: 6px;
            background-color: #94A3B8;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Progress Bar */
        .progress-track {
            height: 4px;
            background: #E2E8F0;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1E88E5, #42A5F5);
            transition: width 0.5s ease;
        }

        /* Touch Active */
        .touch-active:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        /* Modal Overlay */
        .modal-overlay {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: calc(4rem + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%);
            background: #111827;
            color: #F8FAFC;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .toast.show { opacity: 1; }

        /* Ad Card */
        .ad-card {
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
            border: 1px solid #BFDBFE;
            border-radius: 16px;
            padding: 16px;
            margin-top: 12px;
        }
        .ad-card h4 {
            font-weight: 700;
            color: #1E40AF;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .ad-card p {
            font-size: 13px;
            color: #3B82F6;
            margin-bottom: 12px;
        }
        .ad-card a {
            display: block;
            text-align: center;
            background: #1E88E5;
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            margin-bottom: 8px;
        }
        .ad-card a:last-child { margin-bottom: 0; }
        .ad-card .divider {
            height: 1px;
            background: #BFDBFE;
            margin: 12px 0;
        }

        /* Paywall Card */
        .paywall-card {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border: 1px solid #FCD34D;
            border-radius: 16px;
            padding: 16px;
            margin-top: 12px;
        }
        .paywall-card h4 {
            font-weight: 700;
            color: #92400E;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .paywall-card p {
            font-size: 13px;
            color: #B45309;
            margin-bottom: 8px;
        }
        .paywall-card ul {
            font-size: 13px;
            color: #92400E;
            margin-bottom: 12px;
            padding-left: 16px;
        }
        .paywall-card li {
            margin-bottom: 4px;
        }
        .paywall-card button {
            width: 100%;
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            border: none;
            cursor: pointer;
        }

        /* Disabled Input State */
        .input-disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="app-shell">
<div class="app-phone-frame">
<div class="h-[100dvh] w-full flex flex-col overflow-hidden relative">

    <div class="bg-pattern"></div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- === HEADER === -->
    <header class="fixed top-0 left-0 right-0 z-40 bg-white/90 backdrop-blur-md border-b border-borderLight" style="padding-top: env(safe-area-inset-top);">
        <div class="h-14 flex items-center justify-between px-4">
            <div class="flex items-center gap-3">
                <a href="/" class="flex items-center gap-3">
                    <img src="/logo.png" alt="BrotherG" class="w-8 h-8 rounded-lg shadow-md">
                    <span class="font-display font-bold text-lg text-textMain">Tesla é¡§å•</span>
                </a>
            </div>
            <div class="flex items-center gap-2">
                <span id="status-badge" class="text-[10px] font-bold text-aiBlue bg-blue-50 px-2 py-1 rounded-full border border-blue-100">
                    éœ€æ±‚ç›¤é»
                </span>
                <span id="turn-count" class="text-[10px] font-mono text-textSub">0/15</span>
            </div>
        </div>
        <div class="progress-track">
            <div id="progress-bar" class="progress-bar" style="width: 5%;"></div>
        </div>
    </header>

    <!-- === MAIN CHAT AREA === -->
    <main class="flex-1 overflow-y-auto" style="padding-top: calc(4rem + env(safe-area-inset-top)); padding-bottom: calc(5rem + env(safe-area-inset-bottom));" id="chat-container">
        
        <!-- Tesla Icon Header -->
        <div class="text-center py-6 border-b border-borderLight bg-gradient-to-b from-blue-50/50 to-transparent">
            <div class="w-16 h-16 mx-auto mb-3 rounded-2xl bg-white border border-borderLight shadow-sm flex items-center justify-center">
                <img src="/modelx.png" alt="Tesla Model X" class="w-12 h-12 object-contain">
            </div>
            <h1 class="font-display font-bold text-lg text-textMain">Tesla æ±ºç­–é¡§å•</h1>
            <p class="text-xs text-textSub mt-1">15 è¼ªå°è©±ï¼Œå¹«ä½ ææ¸…æ¥šè²·ä¸è²·ã€è²·å“ªå°</p>
        </div>

        <!-- Messages Container -->
        <div id="chat-history" class="flex flex-col gap-4 px-4 py-4">
            <!-- Messages will be added here -->
        </div>
    </main>

    <!-- === INPUT BAR === -->
    <div id="input-bar" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-borderLight z-30" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="p-3 flex items-center gap-3">
            <div class="flex-1 bg-gray-100 rounded-full h-11 flex items-center px-4 border border-gray-200 focus-within:border-aiBlue transition-colors">
                <input type="text" id="chat-input" placeholder="è¼¸å…¥ä½ çš„å›ç­”..." 
                    class="bg-transparent border-none outline-none text-textMain text-sm w-full placeholder-gray-400"
                    autocomplete="off">
            </div>
            <button id="send-btn" onclick="sendMessage()" 
                class="w-11 h-11 rounded-full bg-aiBlue text-white flex items-center justify-center shadow-lg shadow-blue-200 touch-active disabled:opacity-50">
                <i class="fa-solid fa-paper-plane text-sm"></i>
            </button>
        </div>
        <!-- Disabled message (shown after turn 15) -->
        <div id="input-disabled-msg" class="hidden text-center text-xs text-textSub pb-2 px-4">
            å…è²»æ¨¡å¼æœ¬æ¬¡ 15 è¼ªå·²ç”¨å®Œï¼Œè«‹è§£é– Tesla Pro æˆ–æ˜å¤©å†ä¾†
        </div>
    </div>

    <!-- === PRO PAYWALL MODAL (US$1.99) === -->
    <div id="paywall-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-overlay"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl p-6 animate-slide-up shadow-2xl" style="padding-bottom: calc(2rem + env(safe-area-inset-bottom));">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-amber-100 to-amber-200 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-amber-300">
                    <i class="fa-solid fa-crown text-2xl text-amber-600"></i>
                </div>
                <h3 class="text-xl font-bold text-textMain mb-2">è§£é– Tesla Pro æª”æ¡ˆ</h3>
                <p class="text-textSub text-sm">ä¸€æ¬¡æ€§ä»˜è²»ï¼Œæ°¸ä¹…ä¿å­˜ä½ çš„è³¼è»Šæ±ºç­–</p>
            </div>
            
            <div class="bg-gray-50 rounded-xl p-4 mb-4 border border-gray-200">
                <div class="text-center mb-3">
                    <span class="text-3xl font-bold text-textMain">US$ 1.99</span>
                    <span class="text-textSub text-sm ml-1">ä¸€æ¬¡æ€§</span>
                </div>
                <ul class="text-sm text-textSub space-y-2">
                    <li class="flex items-start gap-2">
                        <i class="fa-solid fa-check text-green-500 mt-0.5"></i>
                        <span>ä¿å­˜ä»Šå¤©çš„å…¨éƒ¨éœ€æ±‚èˆ‡å°è©±ç´€éŒ„</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa-solid fa-check text-green-500 mt-0.5"></i>
                        <span>ä¸‹æ¬¡å›ä¾†å¯ç›´æ¥æ¥çºŒï¼Œä¸ç”¨é‡è¬›</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa-solid fa-check text-green-500 mt-0.5"></i>
                        <span>è§£é–å°ˆå±¬è»Šä¸»æ¨¡å¼èˆ‡å¾ŒçºŒå»ºè­°</span>
                    </li>
                </ul>
            </div>

            <button onclick="handleTeslaProCheckout()" id="pro-pay-btn" class="w-full py-4 bg-gradient-to-r from-amber-500 to-amber-600 text-white font-bold rounded-xl touch-active shadow-lg mb-3">
                <i class="fa-brands fa-paypal mr-2"></i>ä»¥ US$1.99 è§£é– Tesla Pro
            </button>
            <button onclick="skipPaywall()" class="w-full py-3 bg-gray-100 text-textSub font-medium rounded-xl touch-active">
                å…ˆå…è²»é«”é©—ï¼Œä¹‹å¾Œå†èªª
            </button>
        </div>
    </div>

    <script>
        // === Config ===
        const MAX_TURNS = 15;
        const TESLA_REFERRAL_URL = 'https://ts.la/arno873937';
        const TRAVEL_AI_URL = 'https://brotherg.ai/travel';

        // === State ===
        let teslaState = {
            turn: 0,
            answers: [],
            messages: [],
            paid: false,
            loading: false,
            sessionEnded: false
        };

        // === Toast ===
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // === Init ===
        function initTesla() {
            teslaState = { turn: 0, answers: [], messages: [], paid: false, loading: false, sessionEnded: false };
            document.getElementById('chat-history').innerHTML = '';
            document.getElementById('input-bar').classList.remove('input-disabled');
            document.getElementById('input-disabled-msg').classList.add('hidden');
            
            // Welcome messages
            addBotMessage("æ­¡è¿ä¾†åˆ° BrotherG Tesla æ±ºç­–é¡§å•ï¼");
            setTimeout(() => {
                addBotMessage("æˆ‘æ˜¯ä½ çš„å°ˆå±¬è³¼è»Šé™ªä¼´é¡§å•ã€‚æ¥ä¸‹ä¾†æˆ‘æœƒç”¨ 15 è¼ªå°è©±ï¼Œå¹«ä½ ææ¸…æ¥šã€Œè²·ä¸è²·ã€è²·å“ªå°ã€ä½•æ™‚è²·ã€ã€‚\n\næº–å‚™å¥½äº†å°±è·Ÿæˆ‘èªªèªªä½ åœ¨è€ƒæ…®ä»€éº¼è»Šæ¬¾å§ï¼");
            }, 600);
            updateUI();
        }

        // === UI Update ===
        function updateUI() {
            const pct = Math.min((teslaState.turn / MAX_TURNS) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            
            let statusText = "éœ€æ±‚ç›¤é»";
            if (teslaState.turn < 10) statusText = "éœ€æ±‚ç›¤é»";
            else if (teslaState.turn === 10) statusText = "ä¸­å ´ç¸½çµ";
            else if (teslaState.turn < 15) statusText = "æ·±åº¦è«®è©¢";
            else statusText = "æœ€çµ‚æ±ºç­–";
            
            document.getElementById('status-badge').innerText = statusText;
            document.getElementById('turn-count').innerText = `${teslaState.turn}/${MAX_TURNS}`;
        }

        // === Chat Messages ===
        function addBotMessage(text, isMarkdown = false) {
            // Task 1 Fix: Guard against empty content
            if (!text || text.trim() === '') {
                console.warn('Attempted to add empty bot message, skipping');
                return;
            }

            const chatHistory = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex items-start gap-2 animate-fade-in';
            
            const content = (isMarkdown && window.marked) ? marked.parse(text) : text.replace(/\n/g, '<br>');
            
            div.innerHTML = `
                <img src="/logo.png" alt="AI" class="w-8 h-8 rounded-full flex-shrink-0 bg-gray-100 p-1 border border-gray-200 mt-1">
                <div class="chat-bubble ai">${content}</div>
            `;
            chatHistory.appendChild(div);
            scrollToBottom();
        }

        function addUserMessage(text) {
            if (!text || text.trim() === '') return;
            
            const chatHistory = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex justify-end animate-fade-in';
            div.innerHTML = `<div class="chat-bubble user">${escapeHtml(text)}</div>`;
            chatHistory.appendChild(div);
            scrollToBottom();
        }

        // === Task 2: Mid-Summary Ad Card (Turn 10) ===
        function addMidSummaryWithAd(summaryText) {
            const chatHistory = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex items-start gap-2 animate-fade-in';
            
            div.innerHTML = `
                <img src="/logo.png" alt="AI" class="w-8 h-8 rounded-full flex-shrink-0 bg-gray-100 p-1 border border-gray-200 mt-1">
                <div class="flex-1">
                    <div class="chat-bubble ai mb-3">${marked.parse(summaryText)}</div>
                    <div class="ad-card">
                        <h4><i class="fa-solid fa-gift mr-2"></i>Tesla æ¨è–¦ç¢¼å°ˆå±¬ç¦®é‡</h4>
                        <p>ä½¿ç”¨ BrotherG æ¨è–¦ç¢¼äº¤è»Šï¼Œå¯äº«æ–°è»Šä¸»å°ˆå±¬å¥½è™•ï¼</p>
                        <a href="${TESLA_REFERRAL_URL}" target="_blank" rel="noopener">
                            <i class="fa-solid fa-bolt mr-2"></i>ä½¿ç”¨æˆ‘çš„ Tesla æ¨è–¦ç¢¼
                        </a>
                        <div class="divider"></div>
                        <h4><i class="fa-solid fa-plane mr-2"></i>äº¤è»Šå¾Œï¼Œä¸€éµè¦åŠƒè‡ªé§•æ—…è¡Œ</h4>
                        <p>ç”¨ BrotherG æ—…éŠæ±ºç­– AI å¹«ä½ æ’å‡ºæœ€é©åˆçš„é›»å‹•è»Šè‡ªé§•è¡Œç¨‹ï¼</p>
                        <a href="${TRAVEL_AI_URL}" target="_blank" rel="noopener">
                            <i class="fa-solid fa-route mr-2"></i>é«”é©—æ—…éŠæ±ºç­– AI
                        </a>
                    </div>
                </div>
            `;
            chatHistory.appendChild(div);
            scrollToBottom();
        }

        // === Task 3: Final Decision with Paywall Card (Turn 15) ===
        function addFinalDecisionWithPaywall(decisionText) {
            const chatHistory = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = 'flex items-start gap-2 animate-fade-in';
            
            div.innerHTML = `
                <img src="/logo.png" alt="AI" class="w-8 h-8 rounded-full flex-shrink-0 bg-gray-100 p-1 border border-gray-200 mt-1">
                <div class="flex-1">
                    <div class="chat-bubble ai mb-3">${marked.parse(decisionText)}</div>
                    <div class="paywall-card">
                        <h4><i class="fa-solid fa-circle-info mr-2"></i>ç›®å‰ç‚ºå…è²»é«”é©—æ¨¡å¼</h4>
                        <p>ä»Šå¤©çš„ 15 è¼ªå°è©±å·²ç¶“ä½¿ç”¨å®Œç•¢ã€‚ä¸‹æ¬¡å†ä¾†æ™‚ï¼Œç³»çµ±æœƒå¾é ­é–‹å§‹ï¼Œç„¡æ³•å®Œæ•´å»¶çºŒä½ çš„æº–è»Šä¸»æª”æ¡ˆã€‚</p>
                        <div class="divider" style="background:#FCD34D;height:1px;margin:12px 0;"></div>
                        <h4><i class="fa-solid fa-crown mr-2"></i>è§£é– Tesla Pro æª”æ¡ˆï¼ˆUS$1.99ï¼‰</h4>
                        <ul>
                            <li>âœ“ ç‚ºä½ ä¿å­˜ä»Šå¤©çš„å…¨éƒ¨éœ€æ±‚èˆ‡å°è©±ç´€éŒ„</li>
                            <li>âœ“ ä¸‹æ¬¡å›ä¾†å¯ç›´æ¥æ¥çºŒï¼Œä¸ç”¨é‡è¬›</li>
                            <li>âœ“ ä¹‹å¾ŒåŠ å…¥æ›´å¤šå°ˆå±¬å»ºè­°èˆ‡è»Šä¸»æ¨¡å¼</li>
                        </ul>
                        <button onclick="openPaywallModal()">
                            <i class="fa-brands fa-paypal mr-2"></i>ä»¥ US$1.99 è§£é– Tesla Pro
                        </button>
                    </div>
                </div>
            `;
            chatHistory.appendChild(div);
            scrollToBottom();

            // Disable input after turn 15
            disableInput();
        }

        function showTypingIndicator() {
            const chatHistory = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.id = 'typing-indicator';
            div.className = 'flex items-start gap-2 animate-fade-in';
            div.innerHTML = `
                <img src="/logo.png" alt="AI" class="w-8 h-8 rounded-full flex-shrink-0 bg-gray-100 p-1 border border-gray-200 mt-1">
                <div class="chat-bubble ai flex gap-1 py-4">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatHistory.appendChild(div);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const el = document.getElementById('typing-indicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            setTimeout(() => {
                container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === Disable Input (after turn 15) ===
        function disableInput() {
            teslaState.sessionEnded = true;
            document.getElementById('chat-input').disabled = true;
            document.getElementById('send-btn').disabled = true;
            document.getElementById('input-bar').classList.add('input-disabled');
            document.getElementById('input-disabled-msg').classList.remove('hidden');
        }

        function enableInput() {
            teslaState.sessionEnded = false;
            document.getElementById('chat-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
            document.getElementById('input-bar').classList.remove('input-disabled');
            document.getElementById('input-disabled-msg').classList.add('hidden');
        }

        // === API Call ===
        async function callTeslaAPI(state, specialMode = null) {
            const payload = {
                messages: state.messages,
                intakeAnswers: state.answers,
                messageCount: state.turn,
                paid: state.paid
            };

            // Add special mode for turn 10 and 15
            if (specialMode) {
                payload.summaryMode = specialMode;
                payload.step = state.turn;
            }

            const res = await fetch('/.netlify/functions/tesla-chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (!res.ok) throw new Error("API Fail");
            return await res.json();
        }

        // === Send Message ===
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            
            if (teslaState.loading || !text || teslaState.sessionEnded) return;

            // Add user message
            addUserMessage(text);
            input.value = '';
            teslaState.messages.push({ role: 'user', content: text });
            teslaState.turn++;
            
            teslaState.answers.push({
                turn: teslaState.turn,
                question: `Turn ${teslaState.turn}`,
                answer: text
            });

            teslaState.loading = true;
            document.getElementById('send-btn').disabled = true;
            updateUI();
            
            // Show typing indicator (Task 1: use indicator, not empty message)
            showTypingIndicator();
            
            try {
                // Determine special mode
                let specialMode = null;
                if (teslaState.turn === 10) specialMode = 'mid';
                else if (teslaState.turn === 15) specialMode = 'final';

                const data = await callTeslaAPI(teslaState, specialMode);
                removeTypingIndicator();

                // Task 1 Fix: Only add message if there's actual content
                if (data.ok && data.reply && data.reply.trim() !== '') {
                    teslaState.messages.push({ role: 'assistant', content: data.reply });
                    
                    // Task 2: Turn 10 - Mid-way summary with ad card
                    if (teslaState.turn === 10) {
                        addMidSummaryWithAd(data.reply);
                    }
                    // Task 3: Turn 15 - Final decision with paywall
                    else if (teslaState.turn >= 15) {
                        addFinalDecisionWithPaywall(data.reply);
                    }
                    // Normal turns
                    else {
                        const isSpecialTurn = teslaState.turn === 11;
                        addBotMessage(data.reply, isSpecialTurn);
                    }
                } else if (!data.ok) {
                    addBotMessage("æŠ±æ­‰ï¼Œæˆ‘éœ€è¦å¤šä¸€é»æ™‚é–“æ€è€ƒã€‚è«‹å†èªªä¸€æ¬¡ä½ çš„æƒ³æ³•ï¼Ÿ");
                }

            } catch (e) {
                console.error('Tesla chat error:', e);
                removeTypingIndicator();
                addBotMessage("æŠ±æ­‰ï¼Œé€£ç·šå‡ºäº†é»å•é¡Œã€‚è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–é‡æ–°æ•´ç†é é¢ã€‚");
            }
            
            teslaState.loading = false;
            if (!teslaState.sessionEnded) {
                document.getElementById('send-btn').disabled = false;
            }
            updateUI();
        }

        // === Paywall ===
        function openPaywallModal() {
            document.getElementById('paywall-modal').classList.remove('hidden');
        }

        function closePaywallModal() {
            document.getElementById('paywall-modal').classList.add('hidden');
        }

        function skipPaywall() {
            closePaywallModal();
            showToast('æ­¡è¿æ˜å¤©å†ä¾†ç¹¼çºŒï¼');
        }

        // === Task 3: Pro Checkout (US$1.99 via PayPal) ===
        async function handleTeslaProCheckout() {
            const btn = document.getElementById('pro-pay-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>è™•ç†ä¸­...';
            btn.disabled = true;

            try {
                // Call existing payment API
                const res = await fetch('/.netlify/functions/payment-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        product: 'tesla_pro',
                        price: 1.99,
                        currency: 'USD',
                        source: 'tesla_app',
                        returnUrl: window.location.href
                    })
                });

                const data = await res.json();

                if (data.checkoutUrl) {
                    // Redirect to PayPal checkout
                    window.location.href = data.checkoutUrl;
                } else if (data.url) {
                    window.location.href = data.url;
                } else {
                    // Fallback: simulate success for demo
                    simulatePaymentSuccess();
                }
            } catch (e) {
                console.error('Payment error:', e);
                // Fallback: simulate success for demo
                simulatePaymentSuccess();
            }
        }

        function simulatePaymentSuccess() {
            const btn = document.getElementById('pro-pay-btn');
            
            setTimeout(() => {
                closePaywallModal();
                teslaState.paid = true;
                enableInput();
                
                showToast('ğŸ‰ Tesla Pro å·²è§£é–ï¼');
                addBotMessage("æ­å–œä½ æˆç‚º Tesla Pro æœƒå“¡ï¼ä½ çš„è³¼è»Šæ±ºç­–æª”æ¡ˆå·²æ°¸ä¹…ä¿å­˜ã€‚æœ‰ä»»ä½•å•é¡Œéš¨æ™‚å›ä¾†ï¼Œæˆ‘éƒ½æœƒè¨˜å¾—ä½ çš„éœ€æ±‚ï¼");
                
                btn.innerHTML = '<i class="fa-brands fa-paypal mr-2"></i>ä»¥ US$1.99 è§£é– Tesla Pro';
                btn.disabled = false;
            }, 1500);
        }

        // === Input Enter Key ===
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // === Init on Load ===
        window.onload = initTesla;
    </script>

</div><!-- end app content -->
</div><!-- end app-phone-frame -->
</div><!-- end app-shell -->
</body>
</html>
