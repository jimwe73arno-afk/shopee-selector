<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Tesla æ±ºç­–é¡§å• | BrotherGAi</title>
    
    <link rel="icon" type="image/png" href="/logo.png">
    <link rel="apple-touch-icon" href="/logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], display: ['Rajdhani', 'sans-serif'] },
                    colors: { appBg: '#020617', appSurface: '#0F172A', primary: '#00A0E9' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #F8FAFC; overscroll-behavior-y: none; }
        ::-webkit-scrollbar { display: none; }
        .app-shell { min-height: 100vh; min-height: 100dvh; display: flex; justify-content: center; align-items: center; background: #050816; }
        .app-phone-frame { width: 100%; max-width: 430px; height: 100vh; height: 100dvh; max-height: 932px; border-radius: 40px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5); position: relative; }
        @media (max-width: 768px) { .app-shell { background: #020617; } .app-phone-frame { max-width: 100%; max-height: 100%; border-radius: 0; box-shadow: none; } }
        .touch-active:active { transform: scale(0.96); opacity: 0.8; }
        .chat-bubble { max-width: 85%; padding: 12px 16px; font-size: 15px; line-height: 1.6; }
        .chat-bubble.ai { background-color: #1E293B; color: #F1F5F9; border-radius: 20px 20px 20px 4px; }
        .chat-bubble.user { background-color: #00A0E9; color: white; border-radius: 20px 20px 4px 20px; margin-left: auto; }
        .blue-filter { filter: brightness(0) saturate(100%) invert(55%) sepia(57%) saturate(2000%) hue-rotate(166deg) brightness(96%) contrast(101%); }
        .progress-bar-bg { width: 90%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 8px auto; }
        .progress-bar-fill { height: 100%; background: #00A0E9; border-radius: 3px; transition: width 0.3s; }
    </style>
</head>
<body>
<div class="app-shell">
<div class="app-phone-frame">
<div id="app-root" class="h-[100dvh] w-full flex flex-col overflow-hidden relative bg-appBg">

    <!-- ===== ç™»å…¥ç•«é¢ ===== -->
    <div id="login-view" class="absolute inset-0 z-50 bg-appBg flex flex-col items-center justify-center p-6">
        <div class="text-center max-w-sm">
            <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-primary/20 border border-primary/30 flex items-center justify-center">
                <img src="/modelx.png" alt="Tesla" class="w-14 h-14 object-contain blue-filter">
            </div>
            <h1 class="text-2xl font-bold text-white mb-2">Tesla æ±ºç­–é¡§å•</h1>
            <p class="text-slate-400 text-sm mb-8">ç™»å…¥å¾Œé–‹å§‹ä½ çš„è³¼è»Šè«®è©¢</p>
            <button onclick="handleGoogleLogin()" id="login-btn" class="w-full py-4 bg-white text-gray-800 font-bold rounded-2xl flex items-center justify-center gap-3 touch-active shadow-lg">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                <span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>
            </button>
        </div>
    </div>

    <!-- ===== ä¸»ç•«é¢ ===== -->
    <div id="main-view" class="hidden flex-1 flex flex-col">
        
        <!-- Header -->
        <header class="bg-appBg/95 backdrop-blur-xl border-b border-slate-800 z-40" style="padding-top: env(safe-area-inset-top);">
            <div class="h-14 flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <a href="/"><img src="/logo.png" alt="BrotherG" class="w-8 h-8 rounded-lg"></a>
                    <span class="font-display font-bold text-lg text-white">Tesla é¡§å•</span>
                </div>
                <div class="flex items-center gap-2">
                    <span id="question-counter" class="text-xs font-medium text-slate-400 bg-slate-800 px-2 py-1 rounded-full">Q1/10</span>
                    <button onclick="handleLogout()" class="text-slate-500 text-sm"><i class="fa-solid fa-arrow-right-from-bracket"></i></button>
                </div>
            </div>
            <div class="px-4 pb-2">
                <div class="progress-bar-bg">
                    <div id="progress-bar" class="progress-bar-fill" style="width: 10%;"></div>
                </div>
            </div>
        </header>

        <!-- èŠå¤©å€åŸŸ -->
        <div id="chat-container" class="flex-1 overflow-y-auto px-4 py-4">
            <div id="chat-history" class="flex flex-col gap-4"></div>
        </div>

        <!-- è¼¸å…¥æ¡† -->
        <div id="input-bar" class="bg-appBg/95 backdrop-blur-xl border-t border-slate-800" style="padding-bottom: env(safe-area-inset-bottom);">
            <div class="p-3 flex items-center gap-3">
                <div class="flex-1 bg-appSurface rounded-full h-11 flex items-center px-4 border border-slate-700 focus-within:border-primary">
                    <input type="text" id="user-input" placeholder="è¼¸å…¥ä½ çš„ç­”æ¡ˆ..." 
                        class="bg-transparent border-none outline-none text-white text-sm w-full placeholder-slate-500" autocomplete="off">
                </div>
                <button id="send-btn" onclick="handleSubmit()" 
                    class="w-11 h-11 rounded-full bg-primary text-white flex items-center justify-center shadow-lg touch-active disabled:opacity-50">
                    <i class="fa-solid fa-paper-plane text-sm"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ===== æ±ºç­–å¡ + ä»˜è²»ç‰† Modal ===== -->
    <div id="decision-modal" class="hidden fixed inset-0 z-60 bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="w-full max-w-md bg-white rounded-2xl p-6 text-gray-900 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">ğŸ¯ ä½ çš„ Tesla æ±ºç­–å¡</h2>
            
            <!-- æ±ºç­–å¡å…§å®¹ -->
            <div id="decision-card-content" class="mb-6 space-y-4">
                <!-- ç”± JS å‹•æ…‹å¡«å…¥ -->
            </div>
            
            <!-- ä¸‰é¸ä¸€æŒ‰éˆ• -->
            <button id="btn-referral" class="w-full py-3.5 bg-gray-900 text-white rounded-xl mb-3 touch-active font-medium">
                ğŸš— ä½¿ç”¨æˆ‘çš„ Tesla å°è³¼ç¢¼ï¼ˆå…è²»ï¼‰
            </button>
            
            <button id="btn-pay" class="w-full py-3.5 bg-red-500 text-white rounded-xl mb-3 touch-active font-medium">
                ğŸ’ æ”¯ä»˜ US$1.99ï¼Œç²å¾—å®Œæ•´ Tesla æ±ºç­–å¡ + è¨˜æ†¶åŠŸèƒ½
            </button>
            
            <button id="btn-tomorrow" class="w-full py-3.5 bg-gray-200 text-gray-700 rounded-xl touch-active font-medium">
                â° å…ˆä¸ç”¨ï¼Œæˆ‘æ˜å¤©å†ä¾†å…è²»å• 10 é¡Œ
            </button>
        </div>
    </div>

</div>
</div>
</div>

<script src="/js/firebase-store.js"></script>
<script>
// ===============================
// TESLA æ±ºç­–å™¨ v1.0 - æ¥µç°¡ç‰ˆï¼ˆå›ºå®š 10 é¡Œï¼‰
// ===============================

// === å›ºå®š 10 é¡Œ ===
const TESLA_QUESTIONS = [
  "Q1/10 ä½ ç¾åœ¨åœ¨è€ƒæ…®è³¼è²·å“ªä¸€æ¬¾ Teslaï¼Ÿï¼ˆModel 3 / Y / X / S / é‚„åœ¨çŒ¶è±«ï¼‰",
  "Q2/10 ä½ çš„ç¸½é ç®—å¤§æ¦‚åœ¨å“ªå€‹å€é–“ï¼Ÿï¼ˆå«ç¨…é‡‘ï¼‹ç‰Œç…§ï¼‰",
  "Q3/10 é€™å°è»Šä¸»è¦æœƒç”¨åœ¨ä»€éº¼å ´æ™¯ï¼Ÿï¼ˆé€šå‹¤ / å®¶åº­ / å•†å‹™ / é•·é€”æ—…è¡Œï¼‰",
  "Q4/10 ä½ å®¶è£¡ç›®å‰å¯ä¸å¯ä»¥å®‰è£å®¶ç”¨å……é›»æ¨ï¼Ÿï¼ˆå¯ä»¥ / ä¸è¡Œ / ä¸ç¢ºå®šï¼‰",
  "Q5/10 ä½ ä¸€å¹´å¤§æ¦‚æœƒé–‹å¹¾å…¬é‡Œï¼Ÿ",
  "Q6/10 ä½ å¸¸è·‘çš„é•·é€”è·¯ç·šå¤§æ¦‚æ˜¯å“ªäº›ï¼Ÿï¼ˆä¾‹å¦‚ï¼šå°ä¸­â†”å°åŒ—ã€å°ä¸­â†”é«˜é›„ï¼‰",
  "Q7/10 ä½ æœ€åœ¨æ„çš„å‰ä¸‰ä»¶äº‹æ˜¯ä»€éº¼ï¼Ÿï¼ˆå¤–è§€ / åŠ é€Ÿ / çºŒèˆª / å“ç‰Œ / ç§‘æŠ€æ„Ÿ / å®‰å…¨ / ä¿å€¼ï¼‰",
  "Q8/10 ä½ ç›®å‰æœ‰æ²’æœ‰æ²¹è»Šæˆ–å…¶ä»–è»Šï¼Ÿå¦‚æœæœ‰ï¼Œæ˜¯ä»€éº¼ï¼Ÿ",
  "Q9/10 ä½ å¸Œæœ›é€™å°è»Šè‡³å°‘é–‹å¹¾å¹´å†æ›ï¼Ÿ",
  "Q10/10 ä½ æœ€æ€•è²·éŒ¯çš„æ˜¯å“ªä¸€é»ï¼Ÿï¼ˆä¾‹å¦‚ï¼šçºŒèˆªä¸å¤ ã€ä¿å€¼çˆ›ã€ç©ºé–“å¤ªå°â€¦ï¼‰"
];

// === ç‹€æ…‹ ===
let currentUser = null;
let currentQuestionIndex = 0;
let answers = [];
let isLoading = false;
let sessionId = null;

// ===============================
// åˆå§‹åŒ–
// ===============================
function initTeslaChat() {
    if (!currentUser) return;
    
    // é‡ç½®ç‹€æ…‹
    currentQuestionIndex = 0;
    answers = [];
    isLoading = false;
    sessionId = `tesla_${currentUser.uid}_${Date.now()}`;
    
    // é¡¯ç¤ºç¬¬ä¸€é¡Œ
    updateProgress();
    addBotMessage(TESLA_QUESTIONS[currentQuestionIndex]);
    
    // ç¶å®šäº‹ä»¶
    document.getElementById("user-input").addEventListener("keydown", async (e) => {
        if (e.key === "Enter" && !isLoading) {
            await handleSubmit();
        }
    });
    
    // æŒ‰éˆ•äº‹ä»¶
    document.getElementById("btn-referral").onclick = () => {
        window.open("https://ts.la/arno873937", "_blank");
    };
    
    document.getElementById("btn-pay").onclick = async () => {
        await handlePayment();
    };
    
    document.getElementById("btn-tomorrow").onclick = () => {
        window.location.href = "/";
    };
}

// ===============================
// ä¸»é‚è¼¯ï¼šé€å‡ºç­”æ¡ˆ
// ===============================
async function handleSubmit() {
    if (isLoading) return;
    
    const inputEl = document.getElementById("user-input");
    const userText = inputEl.value.trim();
    if (!userText) return;

    // 1. é¡¯ç¤ºä½¿ç”¨è€…è¨Šæ¯
    addUserMessage(userText);

    // 2. å­˜ç­”æ¡ˆ
    answers.push({
        questionIndex: currentQuestionIndex,
        question: TESLA_QUESTIONS[currentQuestionIndex],
        answer: userText
    });

    // 3. æ¸…é™¤è¼¸å…¥æ¡†
    inputEl.value = "";

    // 4. æ±ºå®šä¸‹ä¸€æ­¥
    if (currentQuestionIndex < TESLA_QUESTIONS.length - 1) {
        // é‚„æ²’åˆ°æœ€å¾Œä¸€é¡Œ â†’ é¡¯ç¤ºä¸‹ä¸€é¡Œ
        currentQuestionIndex++;
        updateProgress();
        addBotMessage(TESLA_QUESTIONS[currentQuestionIndex]);
        return;
    }

    // 5. å·²ç¶“æ˜¯ç¬¬ 10 é¡Œ â†’ å‘¼å«å¾Œç«¯ç”Ÿæˆæ±ºç­–å¡
    isLoading = true;
    document.getElementById("send-btn").disabled = true;
    document.getElementById("user-input").disabled = true;
    
    addBotMessage("äº†è§£ï¼Œæˆ‘å¹«ä½ æ•´ç†æˆä¸€å¼µ Brother G Tesla æ±ºç­–å¡ï¼Œç¨ç­‰å¹¾ç§’â€¦");

    try {
        const res = await fetch("/.netlify/functions/tesla-decision", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                answers,
                userId: currentUser.uid,
                sessionId: sessionId
            })
        });

        if (!res.ok) throw new Error("API error");

        const data = await res.json();
        
        if (data.ok) {
            showDecisionCardAndPaywall(data);
        } else {
            throw new Error(data.error || "Unknown error");
        }

    } catch (err) {
        console.error("[Tesla] decision error:", err);
        addBotMessage(
            "ç³»çµ±å‰›å‰›æœ‰é»å¿™ï¼Œæ²’æˆåŠŸç”Ÿæˆæ±ºç­–å¡ï¼Œä½†ä½ å‰é¢ 10 é¡Œæˆ‘éƒ½æœ‰è¨˜éŒ„ã€‚\n" +
            "ä½ å¯ä»¥ç¨å¾Œé‡æ•´é é¢å†è©¦ä¸€æ¬¡ï¼Œæˆ–æˆªåœ–å‚³çµ¦æˆ‘äººå·¥å¹«ä½ çœ‹ã€‚"
        );
    } finally {
        isLoading = false;
        document.getElementById("send-btn").disabled = false;
        document.getElementById("user-input").disabled = false;
    }
}

// ===============================
// é¡¯ç¤ºæ±ºç­–å¡ + ä»˜è²»ç‰†
// ===============================
function showDecisionCardAndPaywall(data) {
    const contentDiv = document.getElementById("decision-card-content");
    
    // æ¸…ç©ºå…§å®¹
    contentDiv.innerHTML = "";
    
    // æ±ºç­–æ‘˜è¦
    if (data.decisionSummary) {
        const summaryDiv = document.createElement("div");
        summaryDiv.className = "bg-blue-50 rounded-lg p-4 border border-blue-100";
        summaryDiv.innerHTML = `<p class="font-bold text-gray-900 mb-2">çµè«–ï¼š</p><p class="text-gray-700">${escapeHtml(data.decisionSummary)}</p>`;
        contentDiv.appendChild(summaryDiv);
    }
    
    // é—œéµç†ç”±
    if (data.keyReasons && data.keyReasons.length > 0) {
        const reasonsDiv = document.createElement("div");
        reasonsDiv.className = "bg-green-50 rounded-lg p-4 border border-green-100";
        reasonsDiv.innerHTML = `<p class="font-bold text-gray-900 mb-2">ä¸»è¦ä¾æ“šï¼š</p><ul class="list-disc list-inside text-gray-700 space-y-1">`;
        data.keyReasons.forEach(reason => {
            reasonsDiv.innerHTML += `<li>${escapeHtml(reason)}</li>`;
        });
        reasonsDiv.innerHTML += `</ul>`;
        contentDiv.appendChild(reasonsDiv);
    }
    
    // é¢¨éšªæç¤º
    if (data.risks && data.risks.length > 0) {
        const risksDiv = document.createElement("div");
        risksDiv.className = "bg-yellow-50 rounded-lg p-4 border border-yellow-100";
        risksDiv.innerHTML = `<p class="font-bold text-gray-900 mb-2">é¢¨éšªæé†’ï¼š</p><ul class="list-disc list-inside text-gray-700 space-y-1">`;
        data.risks.forEach(risk => {
            risksDiv.innerHTML += `<li>${escapeHtml(risk)}</li>`;
        });
        risksDiv.innerHTML += `</ul>`;
        contentDiv.appendChild(risksDiv);
    }
    
    // å»ºè­°è¡Œå‹•
    if (data.suggestedActions && data.suggestedActions.length > 0) {
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "bg-purple-50 rounded-lg p-4 border border-purple-100";
        actionsDiv.innerHTML = `<p class="font-bold text-gray-900 mb-2">å»ºè­°è¡Œå‹•ï¼š</p><ul class="list-disc list-inside text-gray-700 space-y-1">`;
        data.suggestedActions.forEach(action => {
            actionsDiv.innerHTML += `<li>${escapeHtml(action)}</li>`;
        });
        actionsDiv.innerHTML += `</ul>`;
        contentDiv.appendChild(actionsDiv);
    }
    
    // é¡¯ç¤º Modal
    document.getElementById("decision-modal").classList.remove("hidden");
}

// ===============================
// UI æ›´æ–°
// ===============================
function updateProgress() {
    const progress = ((currentQuestionIndex + 1) / TESLA_QUESTIONS.length) * 100;
    document.getElementById("progress-bar").style.width = `${progress}%`;
    document.getElementById("question-counter").textContent = `Q${currentQuestionIndex + 1}/10`;
}

function addBotMessage(text) {
    const chatHistory = document.getElementById("chat-history");
    const div = document.createElement("div");
    div.className = "flex items-end gap-2";
    div.innerHTML = `
        <div class="w-8 h-8 rounded-full flex-shrink-0 bg-slate-800 border border-slate-700 flex items-center justify-center">
            <img src="/logo.png" alt="AI" class="w-5 h-5">
        </div>
        <div class="chat-bubble ai">${escapeHtml(text)}</div>
    `;
    chatHistory.appendChild(div);
    scrollToBottom();
}

function addUserMessage(text) {
    const chatHistory = document.getElementById("chat-history");
    const div = document.createElement("div");
    div.className = "flex justify-end";
    div.innerHTML = `<div class="chat-bubble user">${escapeHtml(text)}</div>`;
    chatHistory.appendChild(div);
    scrollToBottom();
}

function scrollToBottom() {
    const container = document.getElementById("chat-container");
    setTimeout(() => container?.scrollTo({ top: container.scrollHeight, behavior: 'smooth' }), 100);
}

function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
}

// ===============================
// ä»˜æ¬¾æµç¨‹
// ===============================
async function handlePayment() {
    const btn = document.getElementById("btn-pay");
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>è·³è½‰ PayPal...';
    btn.disabled = true;

    try {
        const res = await fetch('/.netlify/functions/paypal-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                product: 'BROTHERG_PRO',
                returnUrl: window.location.origin + '/payment/success?product=BROTHERG_PRO&return=/tesla-app&sessionId=' + sessionId,
                cancelUrl: window.location.origin + '/payment/cancel?product=BROTHERG_PRO&return=/tesla-app'
            })
        });
        const data = await res.json();
        if (data.ok && data.checkoutUrl) {
            window.location.href = data.checkoutUrl;
        } else {
            throw new Error('PayPal error');
        }
    } catch (e) {
        console.error('[Tesla] Payment error:', e);
        alert("æ”¯ä»˜ç³»çµ±æš«æ™‚ä¸å¯ç”¨ï¼Œè«‹ç¨å¾Œé‡è©¦");
        btn.innerHTML = 'ğŸ’ æ”¯ä»˜ US$1.99ï¼Œç²å¾—å®Œæ•´ Tesla æ±ºç­–å¡ + è¨˜æ†¶åŠŸèƒ½';
        btn.disabled = false;
    }
}

// ===============================
// Auth
// ===============================
async function handleGoogleLogin() {
    const btn = document.getElementById("login-btn");
    try {
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i>é©—è­‰ä¸­...';
        btn.disabled = true;

        const result = await firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider());
        currentUser = result.user;
        
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("main-view").classList.remove("hidden");
        
        initTeslaChat();
    } catch (err) {
        console.error('[Tesla] Login error:', err);
    } finally {
        btn.innerHTML = '<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google"><span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</span>';
        btn.disabled = false;
    }
}

async function handleLogout() {
    try {
        await firebase.auth().signOut();
        currentUser = null;
        currentQuestionIndex = 0;
        answers = [];
        sessionId = null;
        document.getElementById("chat-history").innerHTML = "";
        document.getElementById("login-view").classList.remove("hidden");
        document.getElementById("main-view").classList.add("hidden");
    } catch (e) {
        console.error('[Tesla] Logout error:', e);
    }
}

// ===============================
// åˆå§‹åŒ–
// ===============================
window.onload = function() {
    firebase.auth().onAuthStateChanged((user) => {
        currentUser = user;
        if (user) {
            document.getElementById("login-view").classList.add("hidden");
            document.getElementById("main-view").classList.remove("hidden");
            initTeslaChat();
        }
    });
};
</script>
</body>
</html>
